{
    email joefoxing@gmail.com
    # Optional: Comment out for production to use real Let's Encrypt
    # acme_ca https://acme-staging-v02.api.letsencrypt.org/directory
}

# ─────────────────────────────────────────────────────────────────────────────
# PRODUCTION: joefoxing.com
# ─────────────────────────────────────────────────────────────────────────────
www.joefoxing.com {
    redir https://joefoxing.com{uri} permanent
}

joefoxing.com {
    encode zstd gzip

    # Reverse Proxy to Production App
    reverse_proxy prod_app:8000 {
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-Proto {scheme}
    }

    # Security Headers
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "DENY"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "geolocation=(), microphone=(), camera=()"
    }

    handle /caddy-health {
        respond "OK" 200
    }

    log {
        output file /data/access_prod.log {
            roll_size 10MB
            roll_keep 5
        }
        format json
    }
}

# ─────────────────────────────────────────────────────────────────────────────
# STAGING: staging.joefoxing.com
# ─────────────────────────────────────────────────────────────────────────────
staging.joefoxing.com {
    encode zstd gzip

    # Reverse Proxy to Staging App
    reverse_proxy staging_app:8000 {
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-Proto {scheme}
    }

    # Security Headers
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "DENY"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "geolocation=(), microphone=(), camera=()"
        X-Robots-Tag "noindex, nofollow" # Don't index staging
    }

    handle /caddy-health {
        respond "OK" 200
    }

    log {
        output file /data/access_staging.log {
            roll_size 10MB
            roll_keep 5
        }
        format json
    }
}