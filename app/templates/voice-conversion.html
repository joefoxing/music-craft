<!DOCTYPE html>
<html class="dark" lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Conversion - AudioCraft</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸŽµ</text></svg>">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#f20df2",
                        "primary-dark": "#c20ac2",
                        "background-light": "#f8f5f8",
                        "background-dark": "#181118",
                        "surface-dark": "#271b27",
                        "border-dark": "#392839",
                    },
                    fontFamily: {
                        "display": ["Space Grotesk", "sans-serif"],
                        "body": ["Space Grotesk", "sans-serif"],
                    },
                    borderRadius: {
                        "DEFAULT": "0.5rem",
                        "lg": "0.75rem",
                        "xl": "1rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
    
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body class="bg-background-light dark:bg-background-dark text-slate-900 dark:text-white font-display antialiased overflow-hidden">
    <div class="flex h-screen w-full">
        {% include "partials/_sidebar.html" %}
        
        <main class="flex-1 flex flex-col min-w-0 bg-background-light dark:bg-background-dark relative overflow-hidden">
            <header class="flex items-center justify-between border-b border-border-dark px-6 py-3 bg-background-light/50 dark:bg-background-dark/50 backdrop-blur-md sticky top-0 z-10">
                <div class="flex items-center gap-4 text-white md:hidden">
                    <button class="text-slate-400 hover:text-white" id="mobileMenuBtn">
                        <span class="material-symbols-outlined">menu</span>
                    </button>
                    <h2 class="text-lg font-bold">Tools</h2>
                </div>
                
                <div class="hidden md:block">
                    <h2 class="text-slate-900 dark:text-white text-lg font-bold tracking-tight">Voice Conversion</h2>
                </div>
                
                <div class="flex items-center gap-4">
                    <div class="flex items-center bg-surface-dark rounded-full px-3 py-1.5 border border-border-dark">
                        <span class="material-symbols-outlined text-primary text-sm mr-2">bolt</span>
                        <span class="text-white text-xs font-bold font-mono">
                            {% if current_user.is_authenticated %}
                            500 CREDITS
                            {% else %}
                            0 CREDITS
                            {% endif %}
                        </span>
                    </div>
                    
                    {% if current_user.is_authenticated %}
                    <a href="{{ url_for('auth.profile') }}" class="p-2 text-slate-400 hover:text-white relative" title="Profile">
                        <span class="material-symbols-outlined">account_circle</span>
                    </a>
                    {% endif %}
                    
                    <button class="p-2 text-slate-400 hover:text-white relative" id="themeToggle">
                        <span class="material-symbols-outlined">dark_mode</span>
                        <span class="absolute top-2 right-2 w-2 h-2 bg-primary rounded-full border-2 border-background-dark"></span>
                    </button>
                </div>
            </header>
            
            <div class="flex-1 overflow-y-auto custom-scrollbar p-6 pb-32">
                <div class="max-w-5xl mx-auto space-y-8">
                    <section class="flex flex-col gap-6">
                        <div class="flex flex-col gap-2">
                            <h2 class="text-3xl md:text-4xl font-bold dark:text-white text-slate-900 tracking-tight">VC/SVC Voice Conversion</h2>
                            <p class="text-slate-500 dark:text-slate-400">Upload a training dataset, train a custom voice model, then convert new vocal stems.</p>
                        </div>
                        
                        <div class="bg-white dark:bg-surface-dark rounded-xl border border-slate-200 dark:border-border-dark p-6 shadow-xl shadow-black/5">
                            <div class="flex items-start justify-between gap-4">
                                <div>
                                    <h3 class="text-xl font-bold dark:text-white text-slate-900 mb-1 flex items-center gap-2">
                                        <span class="material-symbols-outlined text-primary">person</span>
                                        Voice Profiles
                                    </h3>
                                    <p class="text-sm text-slate-500 dark:text-slate-400">Create a profile per target voice.</p>
                                </div>
                                <button id="refreshProfilesBtn" class="btn-secondary flex items-center">
                                    <span class="material-symbols-outlined mr-2">refresh</span>
                                    Refresh
                                </button>
                            </div>
                            
                            <div class="mt-5 grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="bg-slate-50 dark:bg-slate-900/50 rounded-lg border border-slate-200 dark:border-slate-700 p-5">
                                    <h4 class="text-lg font-bold dark:text-white text-slate-900 mb-4 flex items-center gap-2">
                                        <span class="material-symbols-outlined text-primary">add</span>
                                        Create Profile
                                    </h4>
                                    <div class="space-y-3">
                                        <div>
                                            <label for="profileName" class="block text-sm font-medium mb-2">Profile name</label>
                                            <input type="text" id="profileName" class="form-control" placeholder="e.g., My Singing Voice">
                                        </div>
                                        <button id="createProfileBtn" class="btn-primary flex items-center">
                                            <span class="material-symbols-outlined mr-2">add_circle</span>
                                            Create
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="bg-slate-50 dark:bg-slate-900/50 rounded-lg border border-slate-200 dark:border-slate-700 p-5">
                                    <h4 class="text-lg font-bold dark:text-white text-slate-900 mb-4 flex items-center gap-2">
                                        <span class="material-symbols-outlined text-primary">list</span>
                                        Select Profile
                                    </h4>
                                    <div class="space-y-3">
                                        <div>
                                            <label for="profilesSelect" class="block text-sm font-medium mb-2">Profile</label>
                                            <select id="profilesSelect" class="form-control">
                                                <option value="">Loading...</option>
                                            </select>
                                        </div>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                            <div class="rounded-lg border border-slate-200 dark:border-slate-700 bg-white/60 dark:bg-slate-950/30 p-3">
                                                <div class="text-xs text-slate-500 dark:text-slate-400">Dataset duration</div>
                                                <div class="text-sm font-bold" id="datasetDuration">-</div>
                                            </div>
                                            <div class="rounded-lg border border-slate-200 dark:border-slate-700 bg-white/60 dark:bg-slate-950/30 p-3">
                                                <div class="text-xs text-slate-500 dark:text-slate-400">Active model</div>
                                                <div class="text-sm font-bold" id="activeModel">-</div>
                                            </div>
                                        </div>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                            <div class="rounded-lg border border-slate-200 dark:border-slate-700 bg-white/60 dark:bg-slate-950/30 p-3">
                                                <div class="text-xs text-slate-500 dark:text-slate-400">Trainings remaining (month)</div>
                                                <div class="text-sm font-bold" id="trainingsRemaining">-</div>
                                            </div>
                                            <div class="rounded-lg border border-slate-200 dark:border-slate-700 bg-white/60 dark:bg-slate-950/30 p-3">
                                                <div class="text-xs text-slate-500 dark:text-slate-400">Conversions remaining (day)</div>
                                                <div class="text-sm font-bold" id="conversionsRemaining">-</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white dark:bg-surface-dark rounded-xl border border-slate-200 dark:border-border-dark p-6 shadow-xl shadow-black/5">
                            <h3 class="text-xl font-bold dark:text-white text-slate-900 mb-1 flex items-center gap-2">
                                <span class="material-symbols-outlined text-primary">upload</span>
                                Dataset Upload
                            </h3>
                            <p class="text-sm text-slate-500 dark:text-slate-400">Upload 3â€“10 minutes of isolated vocals (wav/flac recommended).</p>
                            
                            <div class="mt-5 grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div class="md:col-span-2">
                                    <label for="datasetFiles" class="block text-sm font-medium mb-2">Dataset files</label>
                                    <input id="datasetFiles" type="file" class="form-control" accept="audio/*" multiple>
                                    <p class="text-xs text-slate-500 mt-2">These files are uploaded to Cloudflare R2 via presigned URLs.</p>
                                </div>
                                <div class="flex items-end">
                                    <button id="uploadDatasetBtn" class="btn-primary flex items-center w-full justify-center">
                                        <span class="material-symbols-outlined mr-2">cloud_upload</span>
                                        Upload
                                    </button>
                                </div>
                            </div>
                            
                            <div class="mt-5">
                                <div class="rounded-lg p-4 border border-primary/30 bg-primary/5 hidden" id="datasetStatus">
                                    <div class="flex items-center gap-3">
                                        <span class="material-symbols-outlined text-primary animate-spin" id="datasetStatusIcon">sync</span>
                                        <div class="flex-1">
                                            <h5 class="font-bold text-slate-900 dark:text-white" id="datasetStatusTitle">Uploading</h5>
                                            <p class="text-sm text-slate-600 dark:text-slate-400" id="datasetStatusMessage">Starting upload...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white dark:bg-surface-dark rounded-xl border border-slate-200 dark:border-border-dark p-6 shadow-xl shadow-black/5">
                            <h3 class="text-xl font-bold dark:text-white text-slate-900 mb-1 flex items-center gap-2">
                                <span class="material-symbols-outlined text-primary">school</span>
                                Training
                            </h3>
                            <p class="text-sm text-slate-500 dark:text-slate-400">Start a training job for the selected profile.</p>
                            
                            <div class="mt-5 grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div>
                                    <label for="trainEpochs" class="block text-sm font-medium mb-2">Epochs</label>
                                    <input id="trainEpochs" type="number" min="1" step="1" class="form-control" value="50">
                                </div>
                                <div>
                                    <label for="trainF0Method" class="block text-sm font-medium mb-2">F0 method</label>
                                    <select id="trainF0Method" class="form-control">
                                        <option value="rmvpe" selected>rmvpe</option>
                                        <option value="crepe">crepe</option>
                                        <option value="dio">dio</option>
                                    </select>
                                </div>
                                <div class="flex items-end">
                                    <button id="startTrainingBtn" class="btn-primary flex items-center w-full justify-center">
                                        <span class="material-symbols-outlined mr-2">play_arrow</span>
                                        Start Training
                                    </button>
                                </div>
                            </div>
                            
                            <div class="mt-5 space-y-3">
                                <div class="rounded-lg p-4 border border-primary/30 bg-primary/5 hidden" id="trainingStatus">
                                    <div class="flex items-center gap-3">
                                        <span class="material-symbols-outlined text-primary animate-spin" id="trainingStatusIcon">sync</span>
                                        <div class="flex-1">
                                            <h5 class="font-bold text-slate-900 dark:text-white" id="trainingStatusTitle">Queued</h5>
                                            <p class="text-sm text-slate-600 dark:text-slate-400" id="trainingStatusMessage">Waiting for updates...</p>
                                        </div>
                                        <div class="text-right">
                                            <span class="text-xs font-mono text-slate-500" id="trainingJobId"> </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white dark:bg-surface-dark rounded-xl border border-slate-200 dark:border-border-dark p-6 shadow-xl shadow-black/5">
                            <h3 class="text-xl font-bold dark:text-white text-slate-900 mb-1 flex items-center gap-2">
                                <span class="material-symbols-outlined text-primary">swap_horiz</span>
                                Conversion
                            </h3>
                            <p class="text-sm text-slate-500 dark:text-slate-400">Convert a new vocal stem using the active model.</p>
                            
                            <div class="mt-5 grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div class="md:col-span-2">
                                    <label for="conversionFile" class="block text-sm font-medium mb-2">Input vocal stem</label>
                                    <input id="conversionFile" type="file" class="form-control" accept="audio/*">
                                </div>
                                <div class="flex items-end">
                                    <button id="startConversionBtn" class="btn-primary flex items-center w-full justify-center">
                                        <span class="material-symbols-outlined mr-2">auto_awesome</span>
                                        Convert
                                    </button>
                                </div>
                            </div>
                            
                            <div class="mt-5 space-y-3">
                                <div class="rounded-lg p-4 border border-primary/30 bg-primary/5 hidden" id="conversionStatus">
                                    <div class="flex items-center gap-3">
                                        <span class="material-symbols-outlined text-primary animate-spin" id="conversionStatusIcon">sync</span>
                                        <div class="flex-1">
                                            <h5 class="font-bold text-slate-900 dark:text-white" id="conversionStatusTitle">Queued</h5>
                                            <p class="text-sm text-slate-600 dark:text-slate-400" id="conversionStatusMessage">Waiting for updates...</p>
                                        </div>
                                        <div class="text-right">
                                            <span class="text-xs font-mono text-slate-500" id="conversionJobId"> </span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="rounded-lg p-4 border border-green-500/30 bg-green-500/5 hidden" id="conversionResult">
                                    <div class="flex items-center gap-3">
                                        <span class="material-symbols-outlined text-green-500">check_circle</span>
                                        <div class="flex-1">
                                            <h5 class="font-bold text-slate-900 dark:text-white">Conversion complete</h5>
                                            <p class="text-sm text-slate-600 dark:text-slate-400">Download your converted stem.</p>
                                        </div>
                                        <a id="downloadConvertedBtn" class="btn-secondary flex items-center" href="#" target="_blank" rel="noopener noreferrer">
                                            <span class="material-symbols-outlined mr-2">download</span>
                                            Download
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>
            </div>
        </main>
    </div>
    
    <!-- JavaScript Includes -->
    <script src="{{ url_for('static', filename='js/utils/fileHandler.js') }}"></script>
    <script src="{{ url_for('static', filename='js/utils/notification.js') }}"></script>
    <script src="{{ url_for('static', filename='js/utils/taskManager.js') }}"></script>
    <script src="{{ url_for('static', filename='js/sidebar.js') }}"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            function notifyError(msg) {
                if (window.NotificationSystem) {
                    window.NotificationSystem.showError(msg);
                } else {
                    alert(msg);
                }
            }

            function notifySuccess(msg) {
                if (window.NotificationSystem) {
                    window.NotificationSystem.showSuccess(msg);
                } else {
                    alert(msg);
                }
            }

            async function ensureCsrfToken() {
                if (window.csrfToken) return window.csrfToken;
                const r = await fetch('/auth/csrf-token', { credentials: 'same-origin' });
                const d = await r.json();
                window.csrfToken = d.csrf_token;
                return window.csrfToken;
            }

            async function apiFetch(path, options) {
                const opts = options ? { ...options } : {};
                opts.credentials = 'same-origin';
                const method = (opts.method || 'GET').toUpperCase();
                if (method !== 'GET' && method !== 'HEAD' && method !== 'OPTIONS') {
                    const csrf = await ensureCsrfToken();
                    opts.headers = { ...(opts.headers || {}), 'X-CSRFToken': csrf };
                }
                return fetch(path, opts);
            }

            const refreshProfilesBtn = document.getElementById('refreshProfilesBtn');
            const createProfileBtn = document.getElementById('createProfileBtn');
            const profileName = document.getElementById('profileName');
            const profilesSelect = document.getElementById('profilesSelect');

            const datasetDuration = document.getElementById('datasetDuration');
            const activeModel = document.getElementById('activeModel');
            const trainingsRemaining = document.getElementById('trainingsRemaining');
            const conversionsRemaining = document.getElementById('conversionsRemaining');

            const datasetFiles = document.getElementById('datasetFiles');
            const uploadDatasetBtn = document.getElementById('uploadDatasetBtn');
            const datasetStatus = document.getElementById('datasetStatus');
            const datasetStatusTitle = document.getElementById('datasetStatusTitle');
            const datasetStatusMessage = document.getElementById('datasetStatusMessage');

            const startTrainingBtn = document.getElementById('startTrainingBtn');
            const trainEpochs = document.getElementById('trainEpochs');
            const trainF0Method = document.getElementById('trainF0Method');
            const trainingStatus = document.getElementById('trainingStatus');
            const trainingStatusTitle = document.getElementById('trainingStatusTitle');
            const trainingStatusMessage = document.getElementById('trainingStatusMessage');
            const trainingJobId = document.getElementById('trainingJobId');

            const startConversionBtn = document.getElementById('startConversionBtn');
            const conversionFile = document.getElementById('conversionFile');
            const conversionStatus = document.getElementById('conversionStatus');
            const conversionStatusTitle = document.getElementById('conversionStatusTitle');
            const conversionStatusMessage = document.getElementById('conversionStatusMessage');
            const conversionJobId = document.getElementById('conversionJobId');
            const conversionResult = document.getElementById('conversionResult');
            const downloadConvertedBtn = document.getElementById('downloadConvertedBtn');

            let trainingPollTimer = null;
            let conversionPollTimer = null;

            function getSelectedProfileId() {
                return profilesSelect ? profilesSelect.value : '';
            }

            function setSummary(summary) {
                const ds = summary && summary.dataset ? summary.dataset : null;
                if (datasetDuration) datasetDuration.textContent = ds && typeof ds.total_minutes !== 'undefined' ? `${ds.total_minutes} min` : '-';
                if (activeModel) activeModel.textContent = summary && summary.active_model ? summary.active_model : '-';
                if (trainingsRemaining) trainingsRemaining.textContent = summary && typeof summary.trainings_remaining !== 'undefined' ? summary.trainings_remaining : '-';
                if (conversionsRemaining) conversionsRemaining.textContent = summary && typeof summary.conversions_remaining !== 'undefined' ? summary.conversions_remaining : '-';
            }

            async function loadProfiles(selectId) {
                if (!profilesSelect) return;
                profilesSelect.innerHTML = '<option value="">Loading...</option>';

                let resp;
                try {
                    resp = await apiFetch('/api/vc/profiles');
                } catch (e) {
                    profilesSelect.innerHTML = '<option value="">Failed to load</option>';
                    notifyError(`Failed to load profiles: ${e.message}`);
                    return;
                }

                const data = await resp.json().catch(() => ({}));
                if (!resp.ok) {
                    profilesSelect.innerHTML = '<option value="">Failed to load</option>';
                    notifyError(data.error || `Failed to load profiles (HTTP ${resp.status})`);
                    return;
                }

                const profiles = Array.isArray(data) ? data : (data.profiles || []);
                if (!profiles.length) {
                    profilesSelect.innerHTML = '<option value="">No profiles yet</option>';
                    setSummary(null);
                    return;
                }

                profilesSelect.innerHTML = '<option value="">Select a profile</option>';
                profiles.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.id;
                    opt.textContent = p.name || `Profile ${p.id}`;
                    profilesSelect.appendChild(opt);
                });

                if (selectId) {
                    profilesSelect.value = selectId;
                }

                if (profilesSelect.value) {
                    await loadProfileDetail(profilesSelect.value);
                } else {
                    setSummary(null);
                }
            }

            async function loadProfileDetail(profileId) {
                if (!profileId) {
                    setSummary(null);
                    return;
                }

                let resp;
                try {
                    resp = await apiFetch(`/api/vc/profiles/${profileId}`);
                } catch (e) {
                    notifyError(`Failed to load profile: ${e.message}`);
                    return;
                }

                const data = await resp.json().catch(() => ({}));
                if (!resp.ok) {
                    notifyError(data.error || `Failed to load profile (HTTP ${resp.status})`);
                    return;
                }

                setSummary(data);
            }

            async function createProfile() {
                const name = profileName ? profileName.value.trim() : '';
                if (!name) {
                    notifyError('Profile name is required');
                    return;
                }

                const resp = await apiFetch('/api/vc/profiles', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                }).catch((e) => ({ ok: false, status: 0, json: async () => ({ error: e.message }) }));

                const data = await resp.json().catch(() => ({}));
                if (!resp.ok) {
                    notifyError(data.error || `Failed to create profile (HTTP ${resp.status})`);
                    return;
                }

                const newId = data.id || (data.profile && data.profile.id);
                if (profileName) profileName.value = '';
                notifySuccess('Profile created');
                await loadProfiles(newId);
            }

            function showDatasetStatus(title, message) {
                if (!datasetStatus) return;
                datasetStatus.classList.remove('hidden');
                if (datasetStatusTitle) datasetStatusTitle.textContent = title;
                if (datasetStatusMessage) datasetStatusMessage.textContent = message;
            }

            function hideDatasetStatus() {
                if (datasetStatus) datasetStatus.classList.add('hidden');
            }

            async function uploadDataset() {
                const profileId = getSelectedProfileId();
                if (!profileId) {
                    notifyError('Select a profile first');
                    return;
                }
                if (!datasetFiles || !datasetFiles.files || !datasetFiles.files.length) {
                    notifyError('Select one or more dataset files');
                    return;
                }

                uploadDatasetBtn.disabled = true;
                showDatasetStatus('Uploading', 'Preparing upload...');

                try {
                    const files = Array.from(datasetFiles.files);
                    for (let i = 0; i < files.length; i++) {
                        const f = files[i];
                        showDatasetStatus('Uploading', `Requesting upload URL (${i + 1}/${files.length})...`);

                        const urlResp = await apiFetch(`/api/vc/profiles/${profileId}/dataset/upload-url`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ filename: f.name, size_bytes: f.size, mime: f.type })
                        });

                        const urlData = await urlResp.json().catch(() => ({}));
                        if (!urlResp.ok) {
                            throw new Error(urlData.error || `Upload URL failed (HTTP ${urlResp.status})`);
                        }

                        const uploadUrl = urlData.upload_url;
                        const r2Key = urlData.r2_key;
                        const fileId = urlData.file_id;

                        if (!uploadUrl || !r2Key || !fileId) {
                            throw new Error('Upload URL response missing fields');
                        }

                        showDatasetStatus('Uploading', `Uploading ${f.name}...`);
                        const putResp = await fetch(uploadUrl, {
                            method: 'PUT',
                            body: f,
                            headers: { 'Content-Type': f.type || 'application/octet-stream' }
                        });

                        if (!putResp.ok) {
                            throw new Error(`Upload failed for ${f.name} (HTTP ${putResp.status})`);
                        }

                        showDatasetStatus('Uploading', `Committing ${f.name}...`);
                        const commitResp = await apiFetch(`/api/vc/profiles/${profileId}/dataset/commit`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ file_id: fileId, r2_key: r2Key, filename: f.name, size_bytes: f.size })
                        });

                        const commitData = await commitResp.json().catch(() => ({}));
                        if (!commitResp.ok) {
                            throw new Error(commitData.error || `Commit failed for ${f.name} (HTTP ${commitResp.status})`);
                        }
                    }

                    notifySuccess('Dataset uploaded');
                    if (datasetFiles) datasetFiles.value = '';
                    await loadProfileDetail(profileId);

                } catch (e) {
                    notifyError(e.message);
                } finally {
                    uploadDatasetBtn.disabled = false;
                    hideDatasetStatus();
                }
            }

            function showTrainingStatus(title, message, jobIdValue) {
                if (!trainingStatus) return;
                trainingStatus.classList.remove('hidden');
                if (trainingStatusTitle) trainingStatusTitle.textContent = title;
                if (trainingStatusMessage) trainingStatusMessage.textContent = message;
                if (trainingJobId) trainingJobId.textContent = jobIdValue ? jobIdValue : '';
            }

            function stopTrainingPoll() {
                if (trainingPollTimer) {
                    clearInterval(trainingPollTimer);
                    trainingPollTimer = null;
                }
            }

            async function pollTrainingJob(jobIdValue) {
                let resp;
                try {
                    resp = await apiFetch(`/api/vc/training-jobs/${jobIdValue}`);
                } catch (e) {
                    showTrainingStatus('Error', e.message, jobIdValue);
                    return;
                }

                const data = await resp.json().catch(() => ({}));
                if (!resp.ok) {
                    showTrainingStatus('Error', data.error || `Status failed (HTTP ${resp.status})`, jobIdValue);
                    return;
                }

                const status = data.status || 'unknown';
                showTrainingStatus(status, data.error || '', jobIdValue);

                if (status === 'succeeded' || status === 'failed' || status === 'canceled') {
                    stopTrainingPoll();
                    await loadProfileDetail(getSelectedProfileId());
                    if (status === 'succeeded') notifySuccess('Training completed');
                    if (status === 'failed') notifyError(data.error || 'Training failed');
                }
            }

            async function startTraining() {
                const profileId = getSelectedProfileId();
                if (!profileId) {
                    notifyError('Select a profile first');
                    return;
                }

                stopTrainingPoll();
                startTrainingBtn.disabled = true;
                showTrainingStatus('Queued', 'Starting training...', '');

                try {
                    const payload = {
                        epochs: trainEpochs ? Number(trainEpochs.value || 0) : undefined,
                        f0_method: trainF0Method ? trainF0Method.value : undefined,
                    };

                    const resp = await apiFetch(`/api/vc/profiles/${profileId}/train`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const data = await resp.json().catch(() => ({}));
                    if (!resp.ok) {
                        throw new Error(data.error || `Training request failed (HTTP ${resp.status})`);
                    }

                    const jobIdValue = data.id || data.job_id || (data.job && data.job.id);
                    if (!jobIdValue) {
                        throw new Error('Training response missing job id');
                    }

                    showTrainingStatus('Queued', 'Polling job status...', jobIdValue);
                    trainingPollTimer = setInterval(() => pollTrainingJob(jobIdValue), 2500);
                    await pollTrainingJob(jobIdValue);

                } catch (e) {
                    notifyError(e.message);
                    showTrainingStatus('Error', e.message, '');
                } finally {
                    startTrainingBtn.disabled = false;
                }
            }

            function showConversionStatus(title, message, jobIdValue) {
                if (!conversionStatus) return;
                conversionStatus.classList.remove('hidden');
                if (conversionStatusTitle) conversionStatusTitle.textContent = title;
                if (conversionStatusMessage) conversionStatusMessage.textContent = message;
                if (conversionJobId) conversionJobId.textContent = jobIdValue ? jobIdValue : '';
            }

            function stopConversionPoll() {
                if (conversionPollTimer) {
                    clearInterval(conversionPollTimer);
                    conversionPollTimer = null;
                }
            }

            async function pollConversionJob(jobIdValue) {
                let resp;
                try {
                    resp = await apiFetch(`/api/vc/conversion-jobs/${jobIdValue}`);
                } catch (e) {
                    showConversionStatus('Error', e.message, jobIdValue);
                    return;
                }

                const data = await resp.json().catch(() => ({}));
                if (!resp.ok) {
                    showConversionStatus('Error', data.error || `Status failed (HTTP ${resp.status})`, jobIdValue);
                    return;
                }

                const status = data.status || 'unknown';
                showConversionStatus(status, data.error || '', jobIdValue);

                if (status === 'succeeded') {
                    stopConversionPoll();
                    if (conversionResult) conversionResult.classList.remove('hidden');
                    if (downloadConvertedBtn) downloadConvertedBtn.href = `/api/vc/conversion-jobs/${jobIdValue}/download`;
                    notifySuccess('Conversion completed');
                    await loadProfileDetail(getSelectedProfileId());
                }

                if (status === 'failed' || status === 'canceled') {
                    stopConversionPoll();
                    notifyError(data.error || 'Conversion failed');
                    await loadProfileDetail(getSelectedProfileId());
                }
            }

            async function startConversion() {
                const profileId = getSelectedProfileId();
                if (!profileId) {
                    notifyError('Select a profile first');
                    return;
                }

                if (!conversionFile || !conversionFile.files || !conversionFile.files[0]) {
                    notifyError('Select an input vocal stem');
                    return;
                }

                stopConversionPoll();
                if (conversionResult) conversionResult.classList.add('hidden');
                startConversionBtn.disabled = true;
                showConversionStatus('Queued', 'Preparing conversion...', '');

                try {
                    const f = conversionFile.files[0];

                    const urlResp = await apiFetch(`/api/vc/profiles/${profileId}/convert/upload-url`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ filename: f.name, size_bytes: f.size, mime: f.type })
                    });

                    const urlData = await urlResp.json().catch(() => ({}));
                    if (!urlResp.ok) {
                        throw new Error(urlData.error || `Upload URL failed (HTTP ${urlResp.status})`);
                    }

                    const uploadUrl = urlData.upload_url;
                    const inputKey = urlData.r2_key || urlData.input_r2_key;

                    if (!uploadUrl || !inputKey) {
                        throw new Error('Conversion upload URL response missing fields');
                    }

                    showConversionStatus('Uploading', `Uploading ${f.name}...`, '');
                    const putResp = await fetch(uploadUrl, {
                        method: 'PUT',
                        body: f,
                        headers: { 'Content-Type': f.type || 'application/octet-stream' }
                    });

                    if (!putResp.ok) {
                        throw new Error(`Upload failed for ${f.name} (HTTP ${putResp.status})`);
                    }

                    showConversionStatus('Queued', 'Starting conversion...', '');
                    const convResp = await apiFetch(`/api/vc/profiles/${profileId}/convert`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ input_r2_key: inputKey })
                    });

                    const convData = await convResp.json().catch(() => ({}));
                    if (!convResp.ok) {
                        throw new Error(convData.error || `Convert request failed (HTTP ${convResp.status})`);
                    }

                    const jobIdValue = convData.id || convData.job_id || (convData.job && convData.job.id);
                    if (!jobIdValue) {
                        throw new Error('Conversion response missing job id');
                    }

                    showConversionStatus('Queued', 'Polling job status...', jobIdValue);
                    conversionPollTimer = setInterval(() => pollConversionJob(jobIdValue), 2500);
                    await pollConversionJob(jobIdValue);

                } catch (e) {
                    notifyError(e.message);
                    showConversionStatus('Error', e.message, '');
                } finally {
                    startConversionBtn.disabled = false;
                }
            }

            if (refreshProfilesBtn) {
                refreshProfilesBtn.addEventListener('click', () => loadProfiles(getSelectedProfileId()));
            }

            if (createProfileBtn) {
                createProfileBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    createProfile();
                });
            }

            if (profilesSelect) {
                profilesSelect.addEventListener('change', () => {
                    stopTrainingPoll();
                    stopConversionPoll();
                    if (conversionResult) conversionResult.classList.add('hidden');
                    if (trainingStatus) trainingStatus.classList.add('hidden');
                    if (conversionStatus) conversionStatus.classList.add('hidden');
                    loadProfileDetail(getSelectedProfileId());
                });
            }

            if (uploadDatasetBtn) {
                uploadDatasetBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    uploadDataset();
                });
            }

            if (startTrainingBtn) {
                startTrainingBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    startTraining();
                });
            }

            if (startConversionBtn) {
                startConversionBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    startConversion();
                });
            }

            const themeToggle = document.getElementById('themeToggle');
            if (themeToggle) {
                themeToggle.addEventListener('click', function() {
                    const html = document.documentElement;
                    if (html.classList.contains('dark')) {
                        html.classList.remove('dark');
                        localStorage.setItem('theme', 'light');
                    } else {
                        html.classList.add('dark');
                        localStorage.setItem('theme', 'dark');
                    }
                });
            }

            // Mobile menu toggle - handled by sidebar.js

            loadProfiles();
        });
    </script>
</body>
</html>
