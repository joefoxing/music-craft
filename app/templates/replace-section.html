<!DOCTYPE html>
<html class="dark" lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Replace Music Section - AudioCraft</title>

    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸŽµ</text></svg>">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap">
    <link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary":            "#f20df2",
                        "primary-dark":       "#c20ac2",
                        "background-light":   "#f8f5f8",
                        "background-dark":    "#181118",
                        "surface-dark":       "#271b27",
                        "border-dark":        "#392839",
                    },
                    fontFamily: {
                        "display": ["Space Grotesk", "sans-serif"],
                        "body":    ["Space Grotesk", "sans-serif"],
                    },
                    borderRadius: {
                        "DEFAULT": "0.5rem",
                        "lg":      "0.75rem",
                        "xl":      "1rem",
                        "full":    "9999px"
                    },
                },
            },
        }
    </script>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">

    <style>
        /* Timeline range picker */
        .timeline-track {
            position: relative;
            height: 48px;
            background: rgba(242, 13, 242, 0.08);
            border: 1px solid rgba(242, 13, 242, 0.2);
            border-radius: 8px;
            cursor: pointer;
            overflow: visible;
        }
        .timeline-selection {
            position: absolute;
            top: 0; bottom: 0;
            background: rgba(242, 13, 242, 0.35);
            border-left: 3px solid #f20df2;
            border-right: 3px solid #f20df2;
            border-radius: 4px;
            pointer-events: none;
        }
        .timeline-handle {
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 16px;
            height: 32px;
            background: #f20df2;
            border-radius: 4px;
            cursor: ew-resize;
            z-index: 2;
            box-shadow: 0 2px 8px rgba(242,13,242,0.5);
        }
        .timeline-handle::after {
            content: '';
            position: absolute;
            inset: 4px 5px;
            border-left: 2px solid rgba(255,255,255,0.4);
            border-right: 2px solid rgba(255,255,255,0.4);
        }
        .timeline-tick {
            position: absolute;
            top: 0; bottom: 0;
            width: 1px;
            background: rgba(255,255,255,0.08);
        }
        .timeline-tick-label {
            position: absolute;
            top: calc(100% + 6px);
            transform: translateX(-50%);
            font-size: 10px;
            color: #94a3b8;
            white-space: nowrap;
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark text-slate-900 dark:text-white font-display antialiased overflow-hidden">
    <div class="flex h-screen w-full">
        {% include "partials/_sidebar.html" %}

        <!-- Main Content -->
        <main class="flex-1 flex flex-col min-w-0 bg-background-light dark:bg-background-dark relative overflow-hidden">

            <!-- Header -->
            <header class="flex items-center justify-between border-b border-border-dark px-6 py-3 bg-background-light/50 dark:bg-background-dark/50 backdrop-blur-md sticky top-0 z-10">
                <div class="flex items-center gap-4 text-white md:hidden">
                    <button class="text-slate-400 hover:text-white" id="mobileMenuBtn">
                        <span class="material-symbols-outlined">menu</span>
                    </button>
                    <h2 class="text-lg font-bold">Replace Section</h2>
                </div>

                <div class="hidden md:block">
                    <h2 class="text-slate-900 dark:text-white text-lg font-bold tracking-tight">Replace Music Section</h2>
                </div>

                <div class="flex items-center gap-4">
                    <div class="flex items-center bg-surface-dark rounded-full px-3 py-1.5 border border-border-dark">
                        <span class="material-symbols-outlined text-primary text-sm mr-2">bolt</span>
                        <span class="text-white text-xs font-bold font-mono">
                            {% if current_user.is_authenticated %}
                            500 CREDITS
                            {% else %}
                            0 CREDITS
                            {% endif %}
                        </span>
                    </div>

                    {% if current_user.is_authenticated %}
                    <a href="{{ url_for('auth.profile') }}" class="p-2 text-slate-400 hover:text-white relative" title="Profile">
                        <span class="material-symbols-outlined">account_circle</span>
                    </a>
                    {% endif %}

                    <button class="p-2 text-slate-400 hover:text-white relative" id="themeToggle">
                        <span class="material-symbols-outlined">dark_mode</span>
                        <span class="absolute top-2 right-2 w-2 h-2 bg-primary rounded-full border-2 border-background-dark"></span>
                    </button>
                </div>
            </header>

            <!-- Scrollable Content -->
            <div class="flex-1 overflow-y-auto custom-scrollbar p-6 pb-32">
                <div class="max-w-3xl mx-auto space-y-8">

                    <!-- Page Title -->
                    <section class="flex flex-col gap-2">
                        <h2 class="text-3xl md:text-4xl font-bold dark:text-white text-slate-900 tracking-tight">Replace Music Section</h2>
                        <p class="text-slate-500 dark:text-slate-400">Replace a specific time range in an existing track with AI-generated audio that matches your prompt and style.</p>
                    </section>

                    <!-- How it works -->
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div class="bg-white dark:bg-surface-dark rounded-xl border border-slate-200 dark:border-border-dark p-4 flex flex-col gap-2">
                            <span class="material-symbols-outlined text-primary text-3xl">search</span>
                            <p class="font-semibold text-sm">1. Identify the track</p>
                            <p class="text-xs text-slate-500 dark:text-slate-400">Provide the Task ID and Audio ID from any previously generated song.</p>
                        </div>
                        <div class="bg-white dark:bg-surface-dark rounded-xl border border-slate-200 dark:border-border-dark p-4 flex flex-col gap-2">
                            <span class="material-symbols-outlined text-primary text-3xl">content_cut</span>
                            <p class="font-semibold text-sm">2. Select the section</p>
                            <p class="text-xs text-slate-500 dark:text-slate-400">Set the start and end time (in seconds) of the region you want replaced.</p>
                        </div>
                        <div class="bg-white dark:bg-surface-dark rounded-xl border border-slate-200 dark:border-border-dark p-4 flex flex-col gap-2">
                            <span class="material-symbols-outlined text-primary text-3xl">auto_fix_high</span>
                            <p class="font-semibold text-sm">3. Describe the replacement</p>
                            <p class="text-xs text-slate-500 dark:text-slate-400">Write a prompt and optional style tags that describe the new audio for that section.</p>
                        </div>
                    </div>

                    <!-- Main Form Card -->
                    <div class="bg-white dark:bg-surface-dark rounded-xl border border-slate-200 dark:border-border-dark p-6 shadow-xl shadow-black/5">
                        <h3 class="text-xl font-bold dark:text-white text-slate-900 mb-6 flex items-center gap-2">
                            <span class="material-symbols-outlined text-primary">content_cut</span>
                            Section Replacement Configuration
                        </h3>

                        <form id="replaceSectionForm" class="space-y-6" novalidate>

                            <!-- â”€â”€â”€ Track Identification â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
                            <div class="bg-slate-50 dark:bg-slate-900/50 rounded-lg border border-slate-200 dark:border-slate-700 p-5">
                                <h4 class="text-base font-bold dark:text-white text-slate-900 mb-4 flex items-center gap-2">
                                    <span class="material-symbols-outlined text-primary">fingerprint</span>
                                    Track Identification <span class="text-red-500 ml-1">*</span>
                                </h4>
                                <p class="text-xs text-slate-500 dark:text-slate-400 mb-4">
                                    Find these IDs in your <a href="/history" class="text-primary hover:text-primary-dark underline">History</a> or <a href="/library" class="text-primary hover:text-primary-dark underline">Library</a>. Click any generated track to view its Task ID and Audio ID.
                                </p>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <!-- Task ID -->
                                    <div>
                                        <label for="taskId" class="block text-sm font-medium mb-1.5">
                                            Task ID <span class="text-red-500">*</span>
                                        </label>
                                        <input
                                            type="text"
                                            id="taskId"
                                            name="taskId"
                                            class="form-control font-mono"
                                            placeholder="2fac****9f72"
                                            required
                                            autocomplete="off"
                                            value="{{ prefill_task_id }}"
                                        >
                                        <p class="text-xs text-slate-500 mt-1">ID of the original music-generation task.</p>
                                    </div>

                                    <!-- Audio ID -->
                                    <div>
                                        <label for="audioId" class="block text-sm font-medium mb-1.5">
                                            Audio ID <span class="text-red-500">*</span>
                                        </label>
                                        <input
                                            type="text"
                                            id="audioId"
                                            name="audioId"
                                            class="form-control font-mono"
                                            placeholder="e231****-****-****-****-****8cadc7dc"
                                            required
                                            autocomplete="off"
                                            value="{{ prefill_audio_id }}"
                                        >
                                        <p class="text-xs text-slate-500 mt-1">ID of the specific audio variation to modify.</p>
                                    </div>
                                </div>
                            </div>

                            <!-- â”€â”€â”€ Section Time Range â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
                            <div class="bg-slate-50 dark:bg-slate-900/50 rounded-lg border border-slate-200 dark:border-slate-700 p-5">
                                <h4 class="text-base font-bold dark:text-white text-slate-900 mb-4 flex items-center gap-2">
                                    <span class="material-symbols-outlined text-primary">schedule</span>
                                    Section Time Range <span class="text-red-500 ml-1">*</span>
                                </h4>

                                <!-- Visual Timeline -->
                                <div class="mb-6">
                                    <label class="block text-sm font-medium mb-3">Visual Timeline (drag handles to set range)</label>

                                    <!-- Duration hint -->
                                    <div class="flex items-center justify-between text-xs text-slate-500 mb-2">
                                        <span>Track duration (seconds):</span>
                                        <div class="flex items-center gap-2">
                                            <input
                                                type="number"
                                                id="trackDuration"
                                                min="10" max="600" value="120" step="1"
                                                class="w-20 px-2 py-1 text-xs bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-lg text-right"
                                            >
                                            <span>sec</span>
                                        </div>
                                    </div>

                                    <!-- Timeline bar -->
                                    <div class="relative pb-7">
                                        <div class="timeline-track" id="timelineTrack">
                                            <!-- Tick marks injected by JS -->
                                            <div class="timeline-selection" id="timelineSelection"></div>
                                            <div class="timeline-handle" id="handleStart" title="Drag to set start time"></div>
                                            <div class="timeline-handle" id="handleEnd" title="Drag to set end time"></div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Numeric inputs -->
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div>
                                        <label for="infillStartS" class="block text-sm font-medium mb-1.5">
                                            Start Time (seconds) <span class="text-red-500">*</span>
                                        </label>
                                        <input
                                            type="number"
                                            id="infillStartS"
                                            name="infillStartS"
                                            class="form-control"
                                            placeholder="10.5"
                                            min="0" step="0.1"
                                            required
                                            value="10"
                                        >
                                        <p class="text-xs text-slate-500 mt-1">Where the replacement section begins.</p>
                                    </div>
                                    <div>
                                        <label for="infillEndS" class="block text-sm font-medium mb-1.5">
                                            End Time (seconds) <span class="text-red-500">*</span>
                                        </label>
                                        <input
                                            type="number"
                                            id="infillEndS"
                                            name="infillEndS"
                                            class="form-control"
                                            placeholder="20.75"
                                            min="0" step="0.1"
                                            required
                                            value="30"
                                        >
                                        <p class="text-xs text-slate-500 mt-1">Where the replacement section ends.</p>
                                    </div>
                                </div>

                                <!-- Duration badge -->
                                <div class="mt-3 flex items-center gap-2">
                                    <span class="material-symbols-outlined text-sm text-primary">timer</span>
                                    <span class="text-sm text-slate-600 dark:text-slate-300">
                                        Selected duration: <strong id="sectionDuration" class="text-primary">20.0s</strong>
                                    </span>
                                </div>
                            </div>

                            <!-- â”€â”€â”€ Prompt & Style â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
                            <div class="bg-slate-50 dark:bg-slate-900/50 rounded-lg border border-slate-200 dark:border-slate-700 p-5">
                                <h4 class="text-base font-bold dark:text-white text-slate-900 mb-4 flex items-center gap-2">
                                    <span class="material-symbols-outlined text-primary">edit_note</span>
                                    Prompt &amp; Style
                                </h4>

                                <!-- Prompt -->
                                <div class="mb-4">
                                    <label for="prompt" class="block text-sm font-medium mb-1.5">
                                        Prompt <span class="text-red-500">*</span>
                                    </label>
                                    <textarea
                                        id="prompt"
                                        name="prompt"
                                        rows="3"
                                        class="form-control resize-none"
                                        placeholder="A calm and relaxing piano track with soft melodies seamlessly continuing the song..."
                                        required
                                        maxlength="500"
                                    ></textarea>
                                    <div class="flex justify-between mt-1">
                                        <p class="text-xs text-slate-500">Describe what the replacement section should sound like.</p>
                                        <span class="text-xs text-slate-500 font-mono"><span id="promptChars">0</span>/500</span>
                                    </div>
                                </div>

                                <!-- Title -->
                                <div class="mb-4">
                                    <label for="title" class="block text-sm font-medium mb-1.5">Title</label>
                                    <input type="text" id="title" name="title" class="form-control" placeholder="Relaxing Piano (edited)" maxlength="100">
                                    <div class="flex justify-between mt-1">
                                        <p class="text-xs text-slate-500">Optional track title for the modified version.</p>
                                        <span class="text-xs text-slate-500 font-mono"><span id="titleChars">0</span>/100</span>
                                    </div>
                                </div>

                                <!-- Tags -->
                                <div class="mb-4">
                                    <label for="tags" class="block text-sm font-medium mb-1.5">Style Tags</label>
                                    <input type="text" id="tags" name="tags" class="form-control" placeholder="Jazz, piano, calm, soft">
                                    <p class="text-xs text-slate-500 mt-1">Comma-separated style descriptors for the replacement section.</p>
                                </div>

                                <!-- Negative Tags -->
                                <div>
                                    <label for="negativeTags" class="block text-sm font-medium mb-1.5">Negative Tags</label>
                                    <input type="text" id="negativeTags" name="negativeTags" class="form-control" placeholder="Rock, heavy, loud, distortion">
                                    <p class="text-xs text-slate-500 mt-1">Comma-separated styles to avoid in the replacement.</p>
                                </div>
                            </div>

                            <!-- â”€â”€â”€ Full Lyrics (optional) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
                            <div>
                                <div class="flex items-center justify-between mb-2">
                                    <label for="fullLyrics" class="text-sm font-medium flex items-center gap-1">
                                        <span class="material-symbols-outlined text-sm text-slate-400">lyrics</span>
                                        Full Lyrics
                                        <span class="text-xs text-slate-400 font-normal ml-1">(optional)</span>
                                    </label>
                                    <button type="button" id="toggleLyrics" class="text-xs text-primary hover:text-primary-dark font-medium flex items-center gap-1">
                                        <span class="material-symbols-outlined text-sm">expand_more</span>
                                        Show / Hide
                                    </button>
                                </div>
                                <div id="lyricsPanel" class="hidden">
                                    <textarea
                                        id="fullLyrics"
                                        name="fullLyrics"
                                        rows="8"
                                        class="form-control resize-y font-mono text-sm"
                                        placeholder="[Verse 1]&#10;Original lyrics here&#10;&#10;[Chorus]&#10;Modified lyrics for this section&#10;&#10;[Verse 2]&#10;More original lyrics"
                                    ></textarea>
                                    <p class="text-xs text-slate-500 mt-1">Include section markers like <code class="bg-slate-100 dark:bg-slate-800 px-1 rounded">[Verse 1]</code>, <code class="bg-slate-100 dark:bg-slate-800 px-1 rounded">[Chorus]</code>, etc. to guide the AI.</p>
                                </div>
                            </div>

                            <!-- â”€â”€â”€ Advanced: Callback URL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
                            <div>
                                <button type="button" id="toggleAdvanced" class="flex items-center gap-2 text-sm font-medium text-slate-500 dark:text-slate-400 hover:text-primary transition-colors">
                                    <span class="material-symbols-outlined text-sm" id="advancedIcon">chevron_right</span>
                                    Advanced Settings
                                </button>
                                <div id="advancedPanel" class="hidden mt-4">
                                    <label for="callBackUrl" class="block text-sm font-medium mb-1.5">Callback URL</label>
                                    <input type="url" id="callBackUrl" name="callBackUrl" class="form-control" placeholder="https://example.com/callback">
                                    <p class="text-xs text-slate-500 mt-1">Optional URL to receive status updates. Leave empty to use the system default.</p>
                                </div>
                            </div>

                            <!-- â”€â”€â”€ Submit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
                            <div class="border-t border-slate-200 dark:border-slate-700 pt-6 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
                                <div>
                                    <h4 class="text-base font-bold dark:text-white text-slate-900">Ready to Replace</h4>
                                    <p class="text-slate-500 dark:text-slate-400 text-sm mt-0.5">Submit to start the AI section replacement.</p>
                                </div>
                                <button type="submit" id="submitBtn" class="btn-primary flex items-center shrink-0">
                                    <span class="material-symbols-outlined mr-2">auto_fix_high</span>
                                    Replace Section
                                </button>
                            </div>
                        </form>

                        <!-- â”€â”€ Processing State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
                        <div id="statusContainer" class="hidden mt-6">
                            <div class="rounded-lg p-4 border border-primary/30 bg-primary/5">
                                <div class="flex items-center gap-3">
                                    <span class="material-symbols-outlined text-primary animate-spin" id="statusIcon">sync</span>
                                    <div class="flex-1">
                                        <h5 class="font-bold text-slate-900 dark:text-white" id="statusTitle">Processing</h5>
                                        <p class="text-sm text-slate-600 dark:text-slate-400" id="statusMessage">Sending replacement request to the AIâ€¦</p>
                                    </div>
                                    <span class="text-xs font-mono text-slate-500" id="statusTaskId"></span>
                                </div>
                                <div class="mt-3">
                                    <progress id="statusProgress" value="0" max="100" class="w-full h-2 rounded-full"></progress>
                                    <div class="flex justify-between text-xs text-slate-500 mt-1">
                                        <span id="statusProgressText">0%</span>
                                        <span id="statusTime">Just started</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- â”€â”€ Success State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
                        <div id="successContainer" class="hidden mt-6">
                            <div class="rounded-lg p-4 border border-green-500/30 bg-green-500/5">
                                <div class="flex items-center gap-3">
                                    <span class="material-symbols-outlined text-green-500 text-3xl">check_circle</span>
                                    <div class="flex-1">
                                        <h5 class="font-bold text-slate-900 dark:text-white">Replacement Job Submitted!</h5>
                                        <p class="text-sm text-slate-600 dark:text-slate-400" id="successMessage">
                                            Your replacement request has been submitted. The AI is generating the new section.
                                        </p>
                                    </div>
                                </div>
                                <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-xs font-medium text-slate-500 mb-1">New Task ID</label>
                                        <div class="flex items-center gap-2">
                                            <code class="bg-slate-100 dark:bg-slate-800 px-2 py-1 rounded text-sm flex-1 break-all" id="successTaskId">-</code>
                                            <button type="button" onclick="copyTaskId()" class="p-1.5 text-slate-400 hover:text-primary" title="Copy">
                                                <span class="material-symbols-outlined text-base">content_copy</span>
                                            </button>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-slate-500 mb-1">Status</label>
                                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 dark:bg-yellow-900/40 dark:text-yellow-300">
                                            <span class="material-symbols-outlined text-xs mr-1">hourglass_empty</span>
                                            Processing
                                        </span>
                                    </div>
                                </div>
                                <div class="mt-4 p-3 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg">
                                    <p class="text-xs text-blue-700 dark:text-blue-300">
                                        <span class="material-symbols-outlined text-sm align-text-bottom mr-1">info</span>
                                        The replacement is processed asynchronously. Check <a href="/history" class="underline font-medium">History</a> to see the result once the callback is received.
                                    </p>
                                </div>
                                <div class="mt-4 flex gap-3 flex-wrap">
                                    <a href="/history" class="btn-secondary flex items-center">
                                        <span class="material-symbols-outlined mr-2">library_music</span>
                                        View History
                                    </a>
                                    <button id="replaceAnotherBtn" class="btn-secondary flex items-center">
                                        <span class="material-symbols-outlined mr-2">add</span>
                                        Replace Another
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- â”€â”€ Error State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
                        <div id="errorContainer" class="hidden mt-6">
                            <div class="rounded-lg p-4 border border-red-500/30 bg-red-500/5">
                                <div class="flex items-center gap-3">
                                    <span class="material-symbols-outlined text-red-500 text-3xl">error</span>
                                    <div class="flex-1">
                                        <h5 class="font-bold text-slate-900 dark:text-white">Replacement Failed</h5>
                                        <p class="text-sm text-slate-600 dark:text-slate-400" id="errorMessage">An error occurred while processing your request.</p>
                                    </div>
                                </div>
                                <div class="mt-4">
                                    <button id="retryBtn" class="btn-primary flex items-center">
                                        <span class="material-symbols-outlined mr-2">refresh</span>
                                        Try Again
                                    </button>
                                </div>
                            </div>
                        </div>

                    </div><!-- /card -->
                </div><!-- /max-w -->
            </div><!-- /scrollable -->
        </main>
    </div>

    <!-- Scripts -->
    <script src="{{ url_for('static', filename='js/utils/notification.js') }}"></script>
    <script src="{{ url_for('static', filename='js/sidebar.js') }}"></script>

    <script>
    // â”€â”€â”€ CSRF token â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    fetch('/auth/csrf-token')
        .then(r => r.json())
        .then(d => { window.csrfToken = d.csrf_token; })
        .catch(() => {});

    // â”€â”€â”€ Pre-fill callback URL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.addEventListener('DOMContentLoaded', function () {
        const cbInput = document.getElementById('callBackUrl');
        const publicBaseUrl = "{{ public_base_url }}";
        if (cbInput && publicBaseUrl && publicBaseUrl !== 'None' && !cbInput.value) {
            cbInput.value = publicBaseUrl + '/callback';
        }

        // â”€â”€â”€ Timeline range picker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const track        = document.getElementById('timelineTrack');
        const selection    = document.getElementById('timelineSelection');
        const handleStart  = document.getElementById('handleStart');
        const handleEnd    = document.getElementById('handleEnd');
        const startInput   = document.getElementById('infillStartS');
        const endInput     = document.getElementById('infillEndS');
        const durInput     = document.getElementById('trackDuration');
        const durationBadge = document.getElementById('sectionDuration');

        function getTotalDuration() { return Math.max(parseFloat(durInput.value) || 120, 10); }

        function timeToPercent(t) { return Math.max(0, Math.min(100, (t / getTotalDuration()) * 100)); }
        function percentToTime(p) { return Math.round((p / 100) * getTotalDuration() * 10) / 10; }

        function renderTicks() {
            // Remove old ticks
            track.querySelectorAll('.timeline-tick, .timeline-tick-label').forEach(e => e.remove());
            const dur = getTotalDuration();
            const step = dur <= 30 ? 5 : dur <= 120 ? 15 : dur <= 300 ? 30 : 60;
            for (let t = step; t < dur; t += step) {
                const pct = (t / dur) * 100;
                const tick = document.createElement('div');
                tick.className = 'timeline-tick';
                tick.style.left = pct + '%';
                track.appendChild(tick);
                const lbl = document.createElement('div');
                lbl.className = 'timeline-tick-label';
                lbl.style.left = pct + '%';
                lbl.textContent = t + 's';
                track.appendChild(lbl);
            }
        }

        function updateUI() {
            const start = parseFloat(startInput.value) || 0;
            const end   = parseFloat(endInput.value)   || 0;
            const dur   = getTotalDuration();
            const startPct = timeToPercent(start);
            const endPct   = timeToPercent(end);

            selection.style.left  = startPct + '%';
            selection.style.width = Math.max(0, endPct - startPct) + '%';
            handleStart.style.left = startPct + '%';
            handleEnd.style.left   = endPct   + '%';

            const sectionLen = Math.max(0, end - start);
            durationBadge.textContent = sectionLen.toFixed(1) + 's';
        }

        // Drag logic
        let dragging = null;
        function startDrag(e, which) {
            dragging = which;
            e.preventDefault();
        }
        handleStart.addEventListener('mousedown', e => startDrag(e, 'start'));
        handleEnd.addEventListener('mousedown',   e => startDrag(e, 'end'));
        handleStart.addEventListener('touchstart', e => startDrag(e, 'start'), { passive: false });
        handleEnd.addEventListener('touchstart',   e => startDrag(e, 'end'),   { passive: false });

        function onMove(clientX) {
            if (!dragging) return;
            const rect = track.getBoundingClientRect();
            const pct  = Math.max(0, Math.min(100, ((clientX - rect.left) / rect.width) * 100));
            const t    = percentToTime(pct);

            if (dragging === 'start') {
                const endVal = parseFloat(endInput.value) || 0;
                startInput.value = Math.min(t, Math.max(0, endVal - 1));
            } else {
                const startVal = parseFloat(startInput.value) || 0;
                endInput.value = Math.max(t, startVal + 1);
            }
            updateUI();
        }

        document.addEventListener('mousemove', e => onMove(e.clientX));
        document.addEventListener('touchmove', e => onMove(e.touches[0].clientX), { passive: true });
        document.addEventListener('mouseup',   () => { dragging = null; });
        document.addEventListener('touchend',  () => { dragging = null; });

        // Click on track to set nearest handle
        track.addEventListener('click', function (e) {
            if (e.target === handleStart || e.target === handleEnd) return;
            const rect  = track.getBoundingClientRect();
            const pct   = ((e.clientX - rect.left) / rect.width) * 100;
            const t     = percentToTime(pct);
            const start = parseFloat(startInput.value) || 0;
            const end   = parseFloat(endInput.value)   || 0;
            if (Math.abs(t - start) <= Math.abs(t - end)) {
                startInput.value = Math.min(t, Math.max(0, end - 1));
            } else {
                endInput.value = Math.max(t, start + 1);
            }
            updateUI();
        });

        // Sync inputs â†’ timeline
        startInput.addEventListener('input', updateUI);
        endInput.addEventListener('input', updateUI);
        durInput.addEventListener('input', () => { renderTicks(); updateUI(); });

        renderTicks();
        updateUI();

        // â”€â”€â”€ Toggle lyrics panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        document.getElementById('toggleLyrics').addEventListener('click', function () {
            const panel = document.getElementById('lyricsPanel');
            panel.classList.toggle('hidden');
            const icon = this.querySelector('.material-symbols-outlined');
            icon.textContent = panel.classList.contains('hidden') ? 'expand_more' : 'expand_less';
        });

        // â”€â”€â”€ Toggle advanced panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        document.getElementById('toggleAdvanced').addEventListener('click', function () {
            const panel = document.getElementById('advancedPanel');
            panel.classList.toggle('hidden');
            const icon = document.getElementById('advancedIcon');
            icon.textContent = panel.classList.contains('hidden') ? 'chevron_right' : 'expand_more';
        });

        // â”€â”€â”€ Character counters â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function charCounter(inputId, countId) {
            const el = document.getElementById(inputId);
            const cnt = document.getElementById(countId);
            if (!el || !cnt) return;
            cnt.textContent = el.value.length;
            el.addEventListener('input', () => { cnt.textContent = el.value.length; });
        }
        charCounter('prompt', 'promptChars');
        charCounter('title', 'titleChars');

        // â”€â”€â”€ Theme toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const themeToggle = document.getElementById('themeToggle');
        if (themeToggle) {
            themeToggle.addEventListener('click', function () {
                const html = document.documentElement;
                if (html.classList.contains('dark')) {
                    html.classList.remove('dark');
                    localStorage.setItem('theme', 'light');
                } else {
                    html.classList.add('dark');
                    localStorage.setItem('theme', 'dark');
                }
            });
        }

        // â”€â”€â”€ Form submission â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const form           = document.getElementById('replaceSectionForm');
        const submitBtn      = document.getElementById('submitBtn');
        const statusContainer  = document.getElementById('statusContainer');
        const successContainer = document.getElementById('successContainer');
        const errorContainer   = document.getElementById('errorContainer');

        function setContainers(active) {
            [statusContainer, successContainer, errorContainer].forEach(c => c.classList.add('hidden'));
            if (active) active.classList.remove('hidden');
        }

        form.addEventListener('submit', async function (e) {
            e.preventDefault();

            // Client-side validation
            const taskId        = document.getElementById('taskId').value.trim();
            const audioId       = document.getElementById('audioId').value.trim();
            const prompt        = document.getElementById('prompt').value.trim();
            const infillStartS  = parseFloat(document.getElementById('infillStartS').value);
            const infillEndS    = parseFloat(document.getElementById('infillEndS').value);

            if (!taskId)  { showFieldError('taskId',  'Task ID is required');  return; }
            if (!audioId) { showFieldError('audioId', 'Audio ID is required'); return; }
            if (!prompt)  { showFieldError('prompt',  'Prompt is required');   return; }
            if (isNaN(infillStartS)) { showFieldError('infillStartS', 'Start time is required'); return; }
            if (isNaN(infillEndS))   { showFieldError('infillEndS',   'End time is required');   return; }
            if (infillStartS >= infillEndS) {
                showFieldError('infillEndS', 'End time must be greater than start time');
                return;
            }

            // Collect optional fields
            const title        = document.getElementById('title').value.trim()        || undefined;
            const tags         = document.getElementById('tags').value.trim()         || undefined;
            const negativeTags = document.getElementById('negativeTags').value.trim() || undefined;
            const fullLyrics   = document.getElementById('fullLyrics').value.trim()   || undefined;
            const callBackUrl  = document.getElementById('callBackUrl').value.trim()  || undefined;

            const payload = { taskId, audioId, prompt, infillStartS, infillEndS };
            if (title)        payload.title        = title;
            if (tags)         payload.tags         = tags;
            if (negativeTags) payload.negativeTags = negativeTags;
            if (fullLyrics)   payload.fullLyrics   = fullLyrics;
            if (callBackUrl)  payload.callBackUrl  = callBackUrl;

            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="material-symbols-outlined mr-2 animate-spin">sync</span>Submittingâ€¦';
            setContainers(statusContainer);

            try {
                const response = await fetch('/api/replace-section', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();

                if (response.ok && result.code === 200) {
                    showSuccess(result);
                } else {
                    showError(result.msg || result.error || 'Replacement request failed. Please try again.');
                }
            } catch (err) {
                console.error('Replace section error:', err);
                showError('Network error: ' + err.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<span class="material-symbols-outlined mr-2">auto_fix_high</span>Replace Section';
            }
        });

        function showSuccess(result) {
            setContainers(successContainer);
            const taskIdEl = document.getElementById('successTaskId');
            if (taskIdEl && result.data && result.data.taskId) {
                taskIdEl.textContent = result.data.taskId;
                window._lastReplaceSectionTaskId = result.data.taskId;
            }
            const msgEl = document.getElementById('successMessage');
            if (msgEl) msgEl.textContent = result.msg || 'Your replacement request has been submitted successfully.';

            document.getElementById('replaceAnotherBtn').addEventListener('click', function () {
                setContainers(null);
                form.reset();
                document.getElementById('promptChars').textContent = '0';
                document.getElementById('titleChars').textContent  = '0';
                updateUI();
            }, { once: true });
        }

        function showError(message) {
            setContainers(errorContainer);
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('retryBtn').onclick = function () {
                setContainers(null);
                form.dispatchEvent(new Event('submit'));
            };
        }

        function showFieldError(fieldId, message) {
            const el = document.getElementById(fieldId);
            if (el) {
                el.classList.add('!border-red-500', 'ring-1', 'ring-red-500/30');
                el.focus();
                // Remove highlight on next input
                el.addEventListener('input', function clear() {
                    el.classList.remove('!border-red-500', 'ring-1', 'ring-red-500/30');
                    el.removeEventListener('input', clear);
                });
            }
            // Show a small toast-style message if notification.js is loaded
            if (window.showNotification) {
                window.showNotification(message, 'error');
            } else {
                alert(message);
            }
        }
    });

    // â”€â”€â”€ Copy Task ID helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function copyTaskId() {
        const id = window._lastReplaceSectionTaskId;
        if (!id) return;
        navigator.clipboard.writeText(id).then(() => {
            if (window.showNotification) window.showNotification('Task ID copied!', 'success');
        }).catch(() => {});
    }
    </script>
</body>
</html>
