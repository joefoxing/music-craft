<!DOCTYPE html>
<html class="dark" lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Singer Persona - AudioCraft</title>

    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸŽ¤</text></svg>">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap">
    <link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary":            "#f20df2",
                        "primary-dark":       "#c20ac2",
                        "background-light":   "#f8f5f8",
                        "background-dark":    "#181118",
                        "surface-dark":       "#271b27",
                        "border-dark":        "#392839",
                    },
                    fontFamily: {
                        "display": ["Space Grotesk", "sans-serif"],
                        "body":    ["Space Grotesk", "sans-serif"],
                    },
                    borderRadius: {
                        "DEFAULT": "0.5rem",
                        "lg":      "0.75rem",
                        "xl":      "1rem",
                        "full":    "9999px"
                    },
                },
            },
        }
    </script>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">

    <style>
        /* Vocal range timeline picker */
        .timeline-track {
            position: relative;
            height: 48px;
            background: rgba(242, 13, 242, 0.08);
            border: 1px solid rgba(242, 13, 242, 0.2);
            border-radius: 8px;
            cursor: pointer;
            overflow: visible;
        }
        .timeline-selection {
            position: absolute;
            top: 0; bottom: 0;
            background: rgba(242, 13, 242, 0.35);
            border-left: 3px solid #f20df2;
            border-right: 3px solid #f20df2;
            border-radius: 4px;
            pointer-events: none;
        }
        .timeline-handle {
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 16px;
            height: 32px;
            background: #f20df2;
            border-radius: 4px;
            cursor: ew-resize;
            z-index: 2;
            box-shadow: 0 2px 8px rgba(242,13,242,0.5);
        }
        .timeline-handle::after {
            content: '';
            position: absolute;
            inset: 4px 5px;
            border-left: 2px solid rgba(255,255,255,0.4);
            border-right: 2px solid rgba(255,255,255,0.4);
        }
        .timeline-tick {
            position: absolute;
            top: 0; bottom: 0;
            width: 1px;
            background: rgba(255,255,255,0.08);
        }
        .timeline-tick-label {
            position: absolute;
            top: calc(100% + 6px);
            transform: translateX(-50%);
            font-size: 10px;
            color: #94a3b8;
            white-space: nowrap;
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark text-slate-900 dark:text-white font-display antialiased overflow-hidden">
    <div class="flex h-screen w-full">
        {% include "partials/_sidebar.html" %}

        <!-- Main Content -->
        <main class="flex-1 flex flex-col min-w-0 bg-background-light dark:bg-background-dark relative overflow-hidden">

            <!-- Header -->
            <header class="flex items-center justify-between border-b border-border-dark px-6 py-3 bg-background-light/50 dark:bg-background-dark/50 backdrop-blur-md sticky top-0 z-10">
                <div class="flex items-center gap-4 text-white md:hidden">
                    <button class="text-slate-400 hover:text-white" id="mobileMenuBtn">
                        <span class="material-symbols-outlined">menu</span>
                    </button>
                    <h2 class="text-lg font-bold">Persona</h2>
                </div>

                <div class="hidden md:block">
                    <h2 class="text-slate-900 dark:text-white text-lg font-bold tracking-tight">AI Singer Persona</h2>
                </div>

                <div class="flex items-center gap-4">
                    <div class="flex items-center bg-surface-dark rounded-full px-3 py-1.5 border border-border-dark">
                        <span class="material-symbols-outlined text-primary text-sm mr-2">bolt</span>
                        <span class="text-white text-xs font-bold font-mono">
                            {% if current_user.is_authenticated %}
                            500 CREDITS
                            {% else %}
                            0 CREDITS
                            {% endif %}
                        </span>
                    </div>

                    {% if current_user.is_authenticated %}
                    <a href="{{ url_for('auth.profile') }}" class="p-2 text-slate-400 hover:text-white relative" title="Profile">
                        <span class="material-symbols-outlined">account_circle</span>
                    </a>
                    {% endif %}

                    <button class="p-2 text-slate-400 hover:text-white relative" id="themeToggle">
                        <span class="material-symbols-outlined">dark_mode</span>
                        <span class="absolute top-2 right-2 w-2 h-2 bg-primary rounded-full border-2 border-background-dark"></span>
                    </button>
                </div>
            </header>

            <!-- Scrollable Content -->
            <div class="flex-1 overflow-y-auto custom-scrollbar p-6 pb-32">
                <div class="max-w-3xl mx-auto space-y-8">

                    <!-- Page Title -->
                    <section class="flex flex-col gap-2">
                        <h2 class="text-3xl md:text-4xl font-bold dark:text-white text-slate-900 tracking-tight">AI Singer Persona</h2>
                        <p class="text-slate-500 dark:text-slate-400">Extract a reusable AI singer identity from a vocal sample in any of your tracks. The generated Persona ID can then be applied when creating new songs in custom mode.</p>
                    </section>

                    <!-- How it works -->
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div class="bg-white dark:bg-surface-dark rounded-xl border border-slate-200 dark:border-border-dark p-4 flex flex-col gap-2">
                            <span class="material-symbols-outlined text-primary text-3xl">search</span>
                            <p class="font-semibold text-sm">1. Pick a source track</p>
                            <p class="text-xs text-slate-500 dark:text-slate-400">Provide the Task ID and Audio ID from any previously generated song with vocals.</p>
                        </div>
                        <div class="bg-white dark:bg-surface-dark rounded-xl border border-slate-200 dark:border-border-dark p-4 flex flex-col gap-2">
                            <span class="material-symbols-outlined text-primary text-3xl">mic</span>
                            <p class="font-semibold text-sm">2. Select a vocal sample</p>
                            <p class="text-xs text-slate-500 dark:text-slate-400">Choose the start and end time (seconds) of a clean vocal section â€” ideally 5â€“30 s.</p>
                        </div>
                        <div class="bg-white dark:bg-surface-dark rounded-xl border border-slate-200 dark:border-border-dark p-4 flex flex-col gap-2">
                            <span class="material-symbols-outlined text-primary text-3xl">badge</span>
                            <p class="font-semibold text-sm">3. Name &amp; describe it</p>
                            <p class="text-xs text-slate-500 dark:text-slate-400">Give the persona a name and description, then use the returned Persona ID in future generations.</p>
                        </div>
                    </div>

                    <!-- Main Form Card -->
                    <div class="bg-white dark:bg-surface-dark rounded-xl border border-slate-200 dark:border-border-dark p-6 shadow-xl shadow-black/5">
                        <h3 class="text-xl font-bold dark:text-white text-slate-900 mb-6 flex items-center gap-2">
                            <span class="material-symbols-outlined text-primary">face</span>
                            Persona Configuration
                        </h3>

                        <form id="personaForm" class="space-y-6" novalidate>

                            <!-- â”€â”€â”€ Track Identification â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
                            <div class="bg-slate-50 dark:bg-slate-900/50 rounded-lg border border-slate-200 dark:border-slate-700 p-5">
                                <h4 class="text-base font-bold dark:text-white text-slate-900 mb-4 flex items-center gap-2">
                                    <span class="material-symbols-outlined text-primary">fingerprint</span>
                                    Source Track <span class="text-red-500 ml-1">*</span>
                                </h4>
                                <p class="text-xs text-slate-500 dark:text-slate-400 mb-4">
                                    Find these IDs in your <a href="/history" class="text-primary hover:text-primary-dark underline">History</a> or <a href="/library" class="text-primary hover:text-primary-dark underline">Library</a>. The track must contain clear vocals.
                                </p>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <!-- Task ID -->
                                    <div>
                                        <label for="taskId" class="block text-sm font-medium mb-1.5">
                                            Task ID <span class="text-red-500">*</span>
                                        </label>
                                        <input
                                            type="text"
                                            id="taskId"
                                            name="taskId"
                                            class="form-control font-mono"
                                            placeholder="2fac****9f72"
                                            required
                                            autocomplete="off"
                                            value="{{ prefill_task_id }}"
                                        >
                                        <p class="text-xs text-slate-500 mt-1">ID of the original music-generation task.</p>
                                    </div>

                                    <!-- Audio ID -->
                                    <div>
                                        <label for="audioId" class="block text-sm font-medium mb-1.5">
                                            Audio ID <span class="text-red-500">*</span>
                                        </label>
                                        <input
                                            type="text"
                                            id="audioId"
                                            name="audioId"
                                            class="form-control font-mono"
                                            placeholder="e231****-****-****-****-****8cadc7dc"
                                            required
                                            autocomplete="off"
                                            value="{{ prefill_audio_id }}"
                                        >
                                        <p class="text-xs text-slate-500 mt-1">ID of the specific audio variation to extract from.</p>
                                    </div>
                                </div>
                            </div>

                            <!-- â”€â”€â”€ Vocal Sample Range â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
                            <div class="bg-slate-50 dark:bg-slate-900/50 rounded-lg border border-slate-200 dark:border-slate-700 p-5">
                                <h4 class="text-base font-bold dark:text-white text-slate-900 mb-4 flex items-center gap-2">
                                    <span class="material-symbols-outlined text-primary">schedule</span>
                                    Vocal Sample Range <span class="text-red-500 ml-1">*</span>
                                </h4>
                                <p class="text-xs text-slate-500 dark:text-slate-400 mb-4">
                                    Select a 5â€“30 second segment containing a clean, clearly audible vocal performance.
                                    Avoid sections with heavy reverb, backing vocals, or instrumental fills.
                                </p>

                                <!-- Visual Timeline -->
                                <div class="mb-6">
                                    <label class="block text-sm font-medium mb-3">Visual Timeline (drag handles to set range)</label>

                                    <!-- Duration hint -->
                                    <div class="flex items-center justify-between text-xs text-slate-500 mb-2">
                                        <span>Track duration (seconds):</span>
                                        <div class="flex items-center gap-2">
                                            <input
                                                type="number"
                                                id="trackDuration"
                                                min="10" max="600" value="120" step="1"
                                                class="w-20 px-2 py-1 text-xs bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-lg text-right"
                                            >
                                            <span>sec</span>
                                        </div>
                                    </div>

                                    <!-- Timeline bar -->
                                    <div class="relative pb-7">
                                        <div class="timeline-track" id="timelineTrack">
                                            <div class="timeline-selection" id="timelineSelection"></div>
                                            <div class="timeline-handle" id="handleStart" title="Drag to set vocal start"></div>
                                            <div class="timeline-handle" id="handleEnd"   title="Drag to set vocal end"></div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Numeric inputs -->
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div>
                                        <label for="vocalStart" class="block text-sm font-medium mb-1.5">
                                            Vocal Start (seconds) <span class="text-red-500">*</span>
                                        </label>
                                        <input
                                            type="number"
                                            id="vocalStart"
                                            name="vocalStart"
                                            class="form-control"
                                            placeholder="10.0"
                                            min="0" step="0.1"
                                            required
                                            value="10"
                                        >
                                        <p class="text-xs text-slate-500 mt-1">Where the vocal sample begins.</p>
                                    </div>
                                    <div>
                                        <label for="vocalEnd" class="block text-sm font-medium mb-1.5">
                                            Vocal End (seconds) <span class="text-red-500">*</span>
                                        </label>
                                        <input
                                            type="number"
                                            id="vocalEnd"
                                            name="vocalEnd"
                                            class="form-control"
                                            placeholder="30.0"
                                            min="0" step="0.1"
                                            required
                                            value="30"
                                        >
                                        <p class="text-xs text-slate-500 mt-1">Where the vocal sample ends.</p>
                                    </div>
                                </div>

                                <!-- Duration badge -->
                                <div class="mt-3 flex items-center gap-2">
                                    <span class="material-symbols-outlined text-sm text-primary">timer</span>
                                    <span class="text-sm text-slate-600 dark:text-slate-300">
                                        Sample duration: <strong id="sampleDuration" class="text-primary">20.0s</strong>
                                    </span>
                                    <span id="durationWarning" class="hidden text-xs text-amber-600 dark:text-amber-400 flex items-center gap-1">
                                        <span class="material-symbols-outlined text-sm">warning</span>
                                        Recommended: 5â€“30 seconds
                                    </span>
                                </div>
                            </div>

                            <!-- â”€â”€â”€ Persona Identity â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
                            <div class="bg-slate-50 dark:bg-slate-900/50 rounded-lg border border-slate-200 dark:border-slate-700 p-5">
                                <h4 class="text-base font-bold dark:text-white text-slate-900 mb-4 flex items-center gap-2">
                                    <span class="material-symbols-outlined text-primary">badge</span>
                                    Persona Identity <span class="text-red-500 ml-1">*</span>
                                </h4>

                                <!-- Name -->
                                <div class="mb-4">
                                    <label for="personaName" class="block text-sm font-medium mb-1.5">
                                        Name <span class="text-red-500">*</span>
                                    </label>
                                    <input
                                        type="text"
                                        id="personaName"
                                        name="personaName"
                                        class="form-control"
                                        placeholder="e.g. Indie Pop Singer, Soulful R&amp;B Vocalist"
                                        required
                                        maxlength="100"
                                        autocomplete="off"
                                    >
                                    <div class="flex justify-between mt-1">
                                        <p class="text-xs text-slate-500">A short, descriptive label for this vocal identity.</p>
                                        <span class="text-xs text-slate-500 font-mono"><span id="nameChars">0</span>/100</span>
                                    </div>
                                </div>

                                <!-- Description -->
                                <div class="mb-4">
                                    <label for="personaDescription" class="block text-sm font-medium mb-1.5">
                                        Description <span class="text-red-500">*</span>
                                    </label>
                                    <textarea
                                        id="personaDescription"
                                        name="personaDescription"
                                        rows="3"
                                        class="form-control resize-none"
                                        placeholder="A warm, breathy female vocalist with a strong mid-range and slight raspy edge. Suited for emotional ballads and chill acoustic tracks."
                                        required
                                        maxlength="500"
                                    ></textarea>
                                    <div class="flex justify-between mt-1">
                                        <p class="text-xs text-slate-500">Describe the vocal characteristics, tone, and best-fit genres.</p>
                                        <span class="text-xs text-slate-500 font-mono"><span id="descChars">0</span>/500</span>
                                    </div>
                                </div>

                                <!-- Style -->
                                <div>
                                    <label for="personaStyle" class="block text-sm font-medium mb-1.5">Style <span class="text-slate-400 font-normal">(optional)</span></label>
                                    <input
                                        type="text"
                                        id="personaStyle"
                                        name="personaStyle"
                                        class="form-control"
                                        placeholder="e.g. Pop, R&amp;B, Soul, Indie"
                                        maxlength="100"
                                        autocomplete="off"
                                    >
                                    <p class="text-xs text-slate-500 mt-1">Music style(s) associated with this persona.</p>
                                </div>
                            </div>

                            <!-- â”€â”€â”€ Tips â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
                            <div class="flex items-start gap-3 rounded-lg bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 p-4">
                                <span class="material-symbols-outlined text-blue-500 mt-0.5 shrink-0">tips_and_updates</span>
                                <div class="text-sm text-blue-700 dark:text-blue-300">
                                    <p class="font-semibold mb-1">Tips for a great persona</p>
                                    <ul class="list-disc list-inside space-y-0.5 text-xs">
                                        <li>Choose a 5â€“30 second section with clear, isolated vocals.</li>
                                        <li>Avoid sections where the singer is harmonising with backing vocals.</li>
                                        <li>Sections right after an intro or at the start of a chorus usually work best.</li>
                                        <li>Once generated, copy the Persona ID and paste it into Music or Cover Generator (custom mode).</li>
                                    </ul>
                                </div>
                            </div>

                            <!-- â”€â”€â”€ Submit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
                            <div class="border-t border-slate-200 dark:border-slate-700 pt-6 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
                                <div>
                                    <h4 class="text-base font-bold dark:text-white text-slate-900">Create Persona</h4>
                                    <p class="text-slate-500 dark:text-slate-400 text-sm mt-0.5">Submit to extract the AI singer identity from your track.</p>
                                </div>
                                <button type="submit" id="submitBtn" class="btn-primary flex items-center shrink-0">
                                    <span class="material-symbols-outlined mr-2">face</span>
                                    Generate Persona
                                </button>
                            </div>
                        </form>

                        <!-- â”€â”€ Processing State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
                        <div id="statusContainer" class="hidden mt-6">
                            <div class="rounded-lg p-4 border border-primary/30 bg-primary/5">
                                <div class="flex items-center gap-3">
                                    <span class="material-symbols-outlined text-primary animate-spin">sync</span>
                                    <div class="flex-1">
                                        <h5 class="font-bold text-slate-900 dark:text-white">Generating Personaâ€¦</h5>
                                        <p class="text-sm text-slate-600 dark:text-slate-400">Extracting vocal identity from your track. This may take a moment.</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- â”€â”€ Success State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
                        <div id="successContainer" class="hidden mt-6">
                            <div class="rounded-lg p-4 border border-green-500/30 bg-green-500/5">
                                <div class="flex items-center gap-3 mb-4">
                                    <span class="material-symbols-outlined text-green-500 text-3xl">check_circle</span>
                                    <div class="flex-1">
                                        <h5 class="font-bold text-slate-900 dark:text-white">Persona Job Submitted!</h5>
                                        <p class="text-sm text-slate-600 dark:text-slate-400">
                                            The AI is building your singer persona. The Persona ID will be available once processing completes.
                                        </p>
                                    </div>
                                </div>

                                <!-- Task ID -->
                                <div class="mb-4">
                                    <label class="block text-xs font-medium text-slate-500 mb-1">Generation Task ID</label>
                                    <div class="flex items-center gap-2">
                                        <code class="bg-slate-100 dark:bg-slate-800 px-3 py-2 rounded-lg text-sm flex-1 break-all font-mono" id="successTaskId">-</code>
                                        <button type="button" onclick="copyText('successTaskId', 'Task ID')" class="p-2 text-slate-400 hover:text-primary transition-colors rounded-lg hover:bg-primary/10" title="Copy Task ID">
                                            <span class="material-symbols-outlined text-base">content_copy</span>
                                        </button>
                                    </div>
                                    <p class="text-xs text-slate-500 mt-1">Use this to track status in <a href="/history" class="text-primary hover:underline">History</a>.</p>
                                </div>

                                <!-- How to use -->
                                <div class="p-3 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg mb-4">
                                    <p class="text-xs text-blue-700 dark:text-blue-300">
                                        <span class="material-symbols-outlined text-sm align-text-bottom mr-1">info</span>
                                        Once the persona finishes processing, the <strong>Persona ID</strong> will appear in your
                                        <a href="/history" class="underline font-medium">History</a> callback data.
                                        Paste it into the <strong>Persona ID</strong> field on the
                                        <a href="/music-generator" class="underline font-medium">Music Generator</a> or
                                        <a href="/cover-generator" class="underline font-medium">Cover Generator</a> (custom mode) to apply this vocal identity.
                                    </p>
                                </div>

                                <div class="flex gap-3 flex-wrap">
                                    <a href="/history" class="btn-secondary flex items-center">
                                        <span class="material-symbols-outlined mr-2">library_music</span>
                                        View History
                                    </a>
                                    <a href="/music-generator" class="btn-secondary flex items-center">
                                        <span class="material-symbols-outlined mr-2">music_note</span>
                                        Music Generator
                                    </a>
                                    <button id="createAnotherBtn" class="btn-secondary flex items-center">
                                        <span class="material-symbols-outlined mr-2">add</span>
                                        Create Another
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- â”€â”€ Error State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
                        <div id="errorContainer" class="hidden mt-6">
                            <div class="rounded-lg p-4 border border-red-500/30 bg-red-500/5">
                                <div class="flex items-center gap-3">
                                    <span class="material-symbols-outlined text-red-500 text-3xl">error</span>
                                    <div class="flex-1">
                                        <h5 class="font-bold text-slate-900 dark:text-white">Persona Generation Failed</h5>
                                        <p class="text-sm text-slate-600 dark:text-slate-400" id="errorMessage">
                                            An error occurred while processing your request.
                                        </p>
                                    </div>
                                </div>
                                <div class="mt-4">
                                    <button id="retryBtn" class="btn-primary flex items-center">
                                        <span class="material-symbols-outlined mr-2">refresh</span>
                                        Try Again
                                    </button>
                                </div>
                            </div>
                        </div>

                    </div><!-- /card -->
                </div><!-- /max-w -->
            </div><!-- /scrollable -->
        </main>
    </div>

    <!-- Scripts -->
    <script src="{{ url_for('static', filename='js/utils/notification.js') }}"></script>
    <script src="{{ url_for('static', filename='js/sidebar.js') }}"></script>

    <script>
    // â”€â”€â”€ CSRF token â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    fetch('/auth/csrf-token')
        .then(r => r.json())
        .then(d => { window.csrfToken = d.csrf_token; })
        .catch(() => {});

    document.addEventListener('DOMContentLoaded', function () {

        // â”€â”€â”€ Prefill from URL params â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function _applyPrefill() {
            const params = new URLSearchParams(window.location.search);
            const tId = params.get('taskId');
            const aId = params.get('audioId');
            const tEl = document.getElementById('taskId');
            const aEl = document.getElementById('audioId');
            if (tEl && tId) { tEl.value = tId; tEl.setAttribute('value', tId); }
            if (aEl && aId) { aEl.value = aId; aEl.setAttribute('value', aId); }
            console.log('[Persona prefill]', { tId, aId, tElValue: tEl?.value, aElValue: aEl?.value });
        }
        _applyPrefill();
        // Retry after a short delay in case browser autocomplete/autofill clears fields
        setTimeout(_applyPrefill, 150);
        setTimeout(_applyPrefill, 500);

        // â”€â”€â”€ Theme toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const themeToggle = document.getElementById('themeToggle');
        if (themeToggle) {
            themeToggle.addEventListener('click', function () {
                const html = document.documentElement;
                if (html.classList.contains('dark')) {
                    html.classList.remove('dark');
                    localStorage.setItem('theme', 'light');
                } else {
                    html.classList.add('dark');
                    localStorage.setItem('theme', 'dark');
                }
            });
        }

        // â”€â”€â”€ Timeline range picker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const track        = document.getElementById('timelineTrack');
        const selection    = document.getElementById('timelineSelection');
        const handleStart  = document.getElementById('handleStart');
        const handleEnd    = document.getElementById('handleEnd');
        const startInput   = document.getElementById('vocalStart');
        const endInput     = document.getElementById('vocalEnd');
        const durInput     = document.getElementById('trackDuration');
        const durationBadge   = document.getElementById('sampleDuration');
        const durationWarning = document.getElementById('durationWarning');

        function getTotalDuration() { return Math.max(parseFloat(durInput.value) || 120, 10); }
        function timeToPercent(t)   { return Math.max(0, Math.min(100, (t / getTotalDuration()) * 100)); }
        function percentToTime(p)   { return Math.round((p / 100) * getTotalDuration() * 10) / 10; }

        function renderTicks() {
            track.querySelectorAll('.timeline-tick, .timeline-tick-label').forEach(e => e.remove());
            const dur  = getTotalDuration();
            const step = dur <= 30 ? 5 : dur <= 120 ? 15 : dur <= 300 ? 30 : 60;
            for (let t = step; t < dur; t += step) {
                const pct = (t / dur) * 100;
                const tick = document.createElement('div');
                tick.className = 'timeline-tick';
                tick.style.left = pct + '%';
                track.appendChild(tick);
                const lbl = document.createElement('div');
                lbl.className = 'timeline-tick-label';
                lbl.style.left = pct + '%';
                lbl.textContent = t + 's';
                track.appendChild(lbl);
            }
        }

        function updateUI() {
            const start = parseFloat(startInput.value) || 0;
            const end   = parseFloat(endInput.value)   || 0;
            const startPct = timeToPercent(start);
            const endPct   = timeToPercent(end);

            selection.style.left  = startPct + '%';
            selection.style.width = Math.max(0, endPct - startPct) + '%';
            handleStart.style.left = startPct + '%';
            handleEnd.style.left   = endPct   + '%';

            const len = Math.max(0, end - start);
            durationBadge.textContent = len.toFixed(1) + 's';

            // Show warning if outside 5â€“30 s recommendation
            if (durationWarning) {
                durationWarning.classList.toggle('hidden', len >= 5 && len <= 30);
            }
        }

        // Drag logic
        let dragging = null;
        function startDrag(e, which) { dragging = which; e.preventDefault(); }
        handleStart.addEventListener('mousedown',  e => startDrag(e, 'start'));
        handleEnd.addEventListener('mousedown',    e => startDrag(e, 'end'));
        handleStart.addEventListener('touchstart', e => startDrag(e, 'start'), { passive: false });
        handleEnd.addEventListener('touchstart',   e => startDrag(e, 'end'),   { passive: false });

        function onMove(clientX) {
            if (!dragging) return;
            const rect = track.getBoundingClientRect();
            const pct  = Math.max(0, Math.min(100, ((clientX - rect.left) / rect.width) * 100));
            const t    = percentToTime(pct);
            if (dragging === 'start') {
                const endVal = parseFloat(endInput.value) || 0;
                startInput.value = Math.min(t, Math.max(0, endVal - 1));
            } else {
                const startVal = parseFloat(startInput.value) || 0;
                endInput.value = Math.max(t, startVal + 1);
            }
            updateUI();
        }

        document.addEventListener('mousemove', e => onMove(e.clientX));
        document.addEventListener('touchmove', e => onMove(e.touches[0].clientX), { passive: true });
        document.addEventListener('mouseup',   () => { dragging = null; });
        document.addEventListener('touchend',  () => { dragging = null; });

        track.addEventListener('click', function (e) {
            if (e.target === handleStart || e.target === handleEnd) return;
            const rect  = track.getBoundingClientRect();
            const pct   = ((e.clientX - rect.left) / rect.width) * 100;
            const t     = percentToTime(pct);
            const start = parseFloat(startInput.value) || 0;
            const end   = parseFloat(endInput.value)   || 0;
            if (Math.abs(t - start) <= Math.abs(t - end)) {
                startInput.value = Math.min(t, Math.max(0, end - 1));
            } else {
                endInput.value = Math.max(t, start + 1);
            }
            updateUI();
        });

        startInput.addEventListener('input', updateUI);
        endInput.addEventListener('input',   updateUI);
        durInput.addEventListener('input',   () => { renderTicks(); updateUI(); });

        renderTicks();
        updateUI();

        // â”€â”€â”€ Character counters â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function charCounter(inputId, countId) {
            const el  = document.getElementById(inputId);
            const cnt = document.getElementById(countId);
            if (!el || !cnt) return;
            cnt.textContent = el.value.length;
            el.addEventListener('input', () => { cnt.textContent = el.value.length; });
        }
        charCounter('personaName',        'nameChars');
        charCounter('personaDescription', 'descChars');

        // â”€â”€â”€ Form submission â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const form             = document.getElementById('personaForm');
        const submitBtn        = document.getElementById('submitBtn');
        const statusContainer  = document.getElementById('statusContainer');
        const successContainer = document.getElementById('successContainer');
        const errorContainer   = document.getElementById('errorContainer');

        function setContainers(active) {
            [statusContainer, successContainer, errorContainer].forEach(c => c.classList.add('hidden'));
            if (active) active.classList.remove('hidden');
        }

        form.addEventListener('submit', async function (e) {
            e.preventDefault();

            // Client-side validation
            const taskId      = document.getElementById('taskId').value.trim();
            const audioId     = document.getElementById('audioId').value.trim();
            const name        = document.getElementById('personaName').value.trim();
            const description = document.getElementById('personaDescription').value.trim();
            const vocalStart  = parseFloat(document.getElementById('vocalStart').value);
            const vocalEnd    = parseFloat(document.getElementById('vocalEnd').value);

            if (!taskId)           { showFieldError('taskId',              'Task ID is required');             return; }
            if (!audioId)          { showFieldError('audioId',             'Audio ID is required');            return; }
            if (!name)             { showFieldError('personaName',         'Persona name is required');        return; }
            if (!description)      { showFieldError('personaDescription',  'Persona description is required'); return; }
            if (isNaN(vocalStart)) { showFieldError('vocalStart',          'Vocal start time is required');    return; }
            if (isNaN(vocalEnd))   { showFieldError('vocalEnd',            'Vocal end time is required');      return; }
            if (vocalStart >= vocalEnd) {
                showFieldError('vocalEnd', 'Vocal end must be greater than vocal start');
                return;
            }

            const sampleLength = vocalEnd - vocalStart;
            if (sampleLength < 2) {
                showFieldError('vocalEnd', 'Sample must be at least 2 seconds long');
                return;
            }

            // Optional style
            const style = (document.getElementById('personaStyle').value.trim()) || undefined;

            const payload = { taskId, audioId, name, description, vocalStart, vocalEnd };
            if (style) payload.style = style;

            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="material-symbols-outlined mr-2 animate-spin">sync</span>Submittingâ€¦';
            setContainers(statusContainer);

            try {
                const headers = { 'Content-Type': 'application/json' };
                if (window.csrfToken) headers['X-CSRFToken'] = window.csrfToken;

                const response = await fetch('/api/generate-persona', {
                    method: 'POST',
                    headers,
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (response.ok && result.code === 200) {
                    showSuccess(result);
                } else {
                    showError(result.msg || result.error || 'Persona generation failed. Please try again.');
                }
            } catch (err) {
                console.error('Persona generation error:', err);
                showError('Network error: ' + err.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<span class="material-symbols-outlined mr-2">face</span>Generate Persona';
            }
        });

        function showSuccess(result) {
            setContainers(successContainer);

            const taskId = result.data && result.data.taskId;
            const taskIdEl = document.getElementById('successTaskId');
            if (taskIdEl) {
                taskIdEl.textContent = taskId || '(pending)';
                window._personaLastTaskId = taskId || null;
            }

            document.getElementById('createAnotherBtn').addEventListener('click', function () {
                setContainers(null);
                form.reset();
                document.getElementById('nameChars').textContent = '0';
                document.getElementById('descChars').textContent = '0';
                updateUI();
            }, { once: true });
        }

        function showError(message) {
            setContainers(errorContainer);
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('retryBtn').onclick = function () {
                setContainers(null);
                form.dispatchEvent(new Event('submit'));
            };
        }

        function showFieldError(fieldId, message) {
            const el = document.getElementById(fieldId);
            if (el) {
                el.classList.add('!border-red-500', 'ring-1', 'ring-red-500/30');
                el.focus();
                el.addEventListener('input', function clear() {
                    el.classList.remove('!border-red-500', 'ring-1', 'ring-red-500/30');
                    el.removeEventListener('input', clear);
                });
            }
            if (window.NotificationSystem) {
                NotificationSystem.showError(message);
            } else {
                alert(message);
            }
        }

        // â”€â”€â”€ Mobile menu â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const sidebar = document.getElementById('main-sidebar');
        if (mobileMenuBtn && sidebar) {
            mobileMenuBtn.addEventListener('click', () => {
                sidebar.classList.toggle('hidden');
                sidebar.classList.toggle('flex');
                sidebar.classList.toggle('fixed');
                sidebar.classList.toggle('inset-0');
                sidebar.classList.toggle('z-40');
            });
        }
    });

    // â”€â”€â”€ Copy helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function copyText(elementId, label) {
        const el = document.getElementById(elementId);
        if (!el) return;
        const text = el.textContent.trim();
        if (!text || text === '-' || text === '(pending)') return;
        navigator.clipboard.writeText(text).then(function () {
            if (window.NotificationSystem) {
                NotificationSystem.showSuccess((label || 'Value') + ' copied to clipboard!');
            }
        }).catch(() => {});
    }
    </script>
</body>
</html>
