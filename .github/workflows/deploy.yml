name: Build and Deploy

on:
  push:
    branches: [main, develop]
    tags: ['v*']
  pull_request:
    branches: [main, develop]
  # Manual rollback trigger
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy/rollback'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
      action:
        description: 'Action to perform'
        required: true
        default: 'deploy'
        type: choice
        options:
          - deploy
          - rollback
      target_sha:
        description: 'Target SHA for rollback (leave empty for previous)'
        required: false
        type: string

env:
  REGISTRY: ghcr.io
  REPO_OWNER: ${{ github.repository_owner }}
  REPO_NAME: music-craft

jobs:
  # ───────────────────────────────────────────────────────────────────────────
  # BUILD & PUSH IMAGES
  # ───────────────────────────────────────────────────────────────────────────
  build:
    runs-on: ubuntu-latest
    if: github.event_name != 'workflow_dispatch' || github.event.inputs.action == 'deploy'
    permissions:
      contents: read
      packages: write
    outputs:
      sha: ${{ steps.meta.outputs.sha }}
      api_image: ${{ steps.meta.outputs.api_image }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }}

      - name: Generate image metadata
        id: meta
        run: |
          SHA=$(git rev-parse HEAD)
          SHORT_SHA=${SHA:0:12}
          echo "sha=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "api_image=${{ env.REGISTRY }}/${{ env.REPO_OWNER }}/${{ env.REPO_NAME }}/api:sha-$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "Building API image for SHA: $SHORT_SHA"

      - name: Build and push API image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.api
          target: production
          push: true
          tags: |
            ${{ steps.meta.outputs.api_image }}
            ${{ env.REGISTRY }}/${{ env.REPO_OWNER }}/music-craft/api:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILDKIT_INLINE_CACHE=1

  # ───────────────────────────────────────────────────────────────────────────
  # RUN TESTS (optional but recommended)
  # ───────────────────────────────────────────────────────────────────────────
  test:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run API tests
        run: |
          echo "Add your test commands here"
          # Example:
          # docker run --rm ${{ needs.build.outputs.api_image }} pytest

      - name: Run Web tests
        run: |
          echo "Add your test commands here"

  # ───────────────────────────────────────────────────────────────────────────
  # DEPLOY TO STAGING
  # ───────────────────────────────────────────────────────────────────────────
  deploy-staging:
    runs-on: ubuntu-latest
    needs: [build, test]
    if: github.ref == 'refs/heads/develop' && github.event_name != 'pull_request'
    environment:
      name: staging
      url: https://${{ vars.STAGING_DOMAIN }}
    concurrency:
      group: staging-deploy
      cancel-in-progress: false  # Don't cancel - deploys must be sequential
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
          log-public-key: false

      - name: Add host to known hosts
        run: |
          mkdir -p ~/.ssh
          echo "${{ vars.STAGING_HOST }} $(cat ssh_host_key 2>/dev/null || echo 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIDUMMY')" >> ~/.ssh/known_hosts
          ssh-keyscan -H ${{ vars.STAGING_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy to staging
        env:
          DEPLOY_SHA: ${{ needs.build.outputs.sha }}
        run: |
          echo "Deploying SHA to STAGING: $DEPLOY_SHA"
          
          ssh ${{ vars.STAGING_USER }}@${{ vars.STAGING_HOST }} << EOF
            set -e
            cd ~/app
            
            # Update IMAGE_TAG in staging env file
            sed -i "s/^IMAGE_TAG=.*/IMAGE_TAG=sha-$DEPLOY_SHA/" .env.staging
            
            # Run staging deploy script
            bash scripts/deploy-staging.sh $DEPLOY_SHA
            
            echo "Staging deploy completed successfully"
          EOF

      - name: Verify staging deployment health
        run: |
          echo "Waiting for services to stabilize..."
          sleep 30
          
          # Check health endpoint
          for i in {1..10}; do
            if curl -sf "https://${{ vars.STAGING_DOMAIN }}/health" > /dev/null 2>&1; then
              echo "Staging health check passed!"
              exit 0
            fi
            echo "Attempt $i/10 - waiting..."
            sleep 10
          done
          
          echo "Staging health check failed!"
          exit 1

      - name: Notify on failure
        if: failure()
        run: |
          echo "Staging deploy failed - consider rollback"
          # Add Slack/Discord notification here

  # ───────────────────────────────────────────────────────────────────────────
  # DEPLOY TO PRODUCTION
  # ───────────────────────────────────────────────────────────────────────────
  deploy-production:
    runs-on: ubuntu-latest
    needs: [build, test]
    if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
    environment:
      name: production
      url: https://${{ vars.DOMAIN }}
    concurrency:
      group: production-deploy
      cancel-in-progress: false  # Don't cancel - deploys must be sequential
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
          log-public-key: false

      - name: Add host to known hosts
        run: |
          mkdir -p ~/.ssh
          echo "${{ vars.PROD_HOST }} $(cat ssh_host_key 2>/dev/null || echo 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIDUMMY')" >> ~/.ssh/known_hosts
          ssh-keyscan -H ${{ vars.PROD_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy to production
        env:
          DEPLOY_SHA: ${{ needs.build.outputs.sha }}
        run: |
          echo "Deploying SHA: $DEPLOY_SHA"
          
          ssh ${{ vars.PROD_USER }}@${{ vars.PROD_HOST }} << EOF
            set -e
            cd ~/app
            
            # Update IMAGE_TAG in env file
            sed -i "s/^IMAGE_TAG=.*/IMAGE_TAG=sha-$DEPLOY_SHA/" .env.prod
            
            # Run deploy script
            bash scripts/deploy.sh $DEPLOY_SHA
            
            echo "Deploy completed successfully"
          EOF

      - name: Verify deployment health
        run: |
          echo "Waiting for services to stabilize..."
          sleep 30
          
          # Check health endpoint
          for i in {1..10}; do
            if curl -sf "https://${{ vars.DOMAIN }}/health" > /dev/null 2>&1; then
              echo "Health check passed!"
              exit 0
            fi
            echo "Attempt $i/10 - waiting..."
            sleep 10
          done
          
          echo "Health check failed!"
          exit 1

      - name: Notify on failure
        if: failure()
        run: |
          echo "Deploy failed - consider rollback"
          # Add Slack/Discord notification here
          # curl -X POST ${{ secrets.SLACK_WEBHOOK }} -d '{"text":"Deploy failed!"}'

  # ───────────────────────────────────────────────────────────────────────────
  # ROLLBACK WORKFLOWS
  # ───────────────────────────────────────────────────────────────────────────
  rollback-staging:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'rollback' && github.event.inputs.environment == 'staging'
    environment:
      name: staging
    concurrency:
      group: staging-deploy
      cancel-in-progress: false
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add host to known hosts
        run: ssh-keyscan -H ${{ vars.STAGING_HOST }} >> ~/.ssh/known_hosts

      - name: Execute staging rollback
        run: |
          TARGET_SHA="${{ github.event.inputs.target_sha }}"
          
          ssh ${{ vars.STAGING_USER }}@${{ vars.STAGING_HOST }} << EOF
            set -e
            cd ~/app
            
            if [ -n "$TARGET_SHA" ]; then
              echo "Rolling back STAGING to specific SHA: $TARGET_SHA"
              bash scripts/rollback-staging.sh $TARGET_SHA
            else
              echo "Rolling back STAGING to previous version"
              bash scripts/rollback-staging.sh
            fi
            
            echo "Staging rollback completed"
          EOF

      - name: Verify staging rollback health
        run: |
          sleep 15
          curl -sf "https://${{ vars.STAGING_DOMAIN }}/health" || exit 1
          echo "Staging rollback health check passed"

  rollback-production:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'rollback' && github.event.inputs.environment == 'production'
    environment:
      name: production
    concurrency:
      group: production-deploy
      cancel-in-progress: false
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add host to known hosts
        run: ssh-keyscan -H ${{ vars.PROD_HOST }} >> ~/.ssh/known_hosts

      - name: Execute rollback
        run: |
          TARGET_SHA="${{ github.event.inputs.target_sha }}"
          
          ssh ${{ vars.PROD_USER }}@${{ vars.PROD_HOST }} << EOF
            set -e
            cd ~/app
            
            if [ -n "$TARGET_SHA" ]; then
              echo "Rolling back to specific SHA: $TARGET_SHA"
              bash scripts/rollback.sh $TARGET_SHA
            else
              echo "Rolling back to previous version"
              bash scripts/rollback.sh
            fi
            
            echo "Rollback completed"
          EOF

      - name: Verify rollback health
        run: |
          sleep 15
          curl -sf "https://${{ vars.DOMAIN }}/health" || exit 1
          echo "Rollback health check passed"

  # ───────────────────────────────────────────────────────────────────────────
  # TAG CLEANUP (optional)
  # ───────────────────────────────────────────────────────────────────────────
  cleanup:
    runs-on: ubuntu-latest
    needs: [deploy-production, deploy-staging]
    if: always() && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    steps:
      - name: Delete old container images
        uses: actions/delete-package-versions@v4
        with:
          package-name: '${{ env.REPO_NAME }}/api'
          package-type: 'container'
          min-versions-to-keep: 10
          delete-only-untagged-versions: false
        continue-on-error: true
